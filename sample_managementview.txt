create or replace view ORBIT_DEV.CERBA.SAMPLE_MANAGEMENT_TOOL_GD_VW(
	TA,
	PROTOCOL_ID,
	VENDOR,
	SAMPLE_CATEGORY,
	SUBJECT_ID,
	SUBJECT_STATUS,
	STUDY_ARM,
	COUNTRY,
	SITE_NAME,
	PI_NAME,
	COHORT,
	LABCORP_PVC,
	VISIT_NAME,
	LABEL_LINE_1,
	SM_DESCRIPTION,
	ACCESSION_NUMBER,
	CONTAINER_NUMBER,
	RECEIPT_TEMPERATURE,
	SHIPPING_DATETIME,
	SHIPPING_DESTINATION,
	SAMPLE_TYPE,
	COLLECTION_DATETIME,
	ACTUAL_VISIT_DATE,
	LATEST_MODIFIED_TIME,
	SITE_ID,
	ALIQUOT,
	NOT_MAPPED,
	EXPECTED_VISIT_MIN,
	EXPECTED_VISIT_MAX,
	EXPECTED_VISIT_WINDOW,
	DATA_STATUS_EDC_RAVE,
	DATA_STATUS_LABCORP,
	POT_MISSING,
	REVIEW_ITEM,
	ROW_ID
) as SELECT asv.ta, asv.protocol_id, 'LabCorp' AS vendor, 'Biologics' AS sample_category, asv.subject_id, asv.subject_status, asv.study_arm, asv.country, asv.site_name, asv.pi_name, asv.cohort, asv.labcorp_pvc, asv.visit_name, asv.label_line_1, asv.sm_description, asv.accession_number, asv.container_number, asv.receipt_temperature, asv.shipping_datetime, asv.shipping_destination, COALESCE(asv.sample_type, rt.sample_type::character varying) AS sample_type, asv.collection_datetime, asv.actual_visit_date, asv.latest_modified_time, asv.site_id, asv.aliquot, 
        CASE
            WHEN asv.sm_code::text LIKE '%SM13%'::text OR asv.labcorp_pvc::text = 'BMAMRDSLID'::text THEN 'N'::character varying
            ELSE asv.not_mapped
        END AS not_mapped, 
        CASE
            WHEN asv.visit_oid = 'C1D1' THEN rand.visit_date_actl
ELSE DATEADD(
    day,
    (acl.cycle_length * (asv.cycle - lsv.cycle) + asv.day - lsv.day - asv.visit_window),
    lsv.actual_visit_date
)
        END AS expected_visit_min, 
        CASE
           WHEN asv.visit_oid = 'C1D1'
THEN DATEADD(day, 7, rand.visit_date_actl)
           ELSE DATEADD(
    day,
    acl.cycle_length * (asv.cycle - lsv.cycle) + asv.day - lsv.day + asv.visit_window,
    lsv.actual_visit_date
)
END AS expected_visit_max,

(
    CASE
        WHEN asv.visit_oid = 'C1D1' THEN rand.visit_date_actl
        ELSE DATEADD(
            day,
            acl.cycle_length * (asv.cycle - lsv.cycle) + asv.day - lsv.day - asv.visit_window,
            lsv.actual_visit_date
        )
    END::string || ' to '
) ||
CASE
    WHEN asv.visit_oid = 'C1D1' THEN DATEADD(day, 7, rand.visit_date_actl)
    ELSE DATEADD(
        day,
        acl.cycle_length * (asv.cycle - lsv.cycle) + asv.day - lsv.day + asv.visit_window,
        lsv.actual_visit_date
    )
        END::text AS expected_visit_window, 
        CASE
            WHEN asv.actual_visit_date IS NOT NULL THEN 'Y'::text
            ELSE 'N'::text
        END AS data_status_edc_rave, 
        CASE
            WHEN asv.specimen_id IS NOT NULL THEN 'Y'::text
            ELSE 'N'::text
        END AS data_status_labcorp, 
        CASE
            WHEN lsv.actual_visit_date < 
            CASE
                WHEN asv.visit_oid = 'C1D1' THEN rand.visit_date_actl
ELSE DATEADD(
    day,
    acl.cycle_length * (asv.cycle - lsv.cycle) + asv.day - lsv.day - asv.visit_window,
    lsv.actual_visit_date
)
END AND 
CASE
    WHEN asv.visit_oid = 'C1D1' THEN DATEADD(day, 7, rand.visit_date_actl)
    ELSE DATEADD(
        day,
        acl.cycle_length * (asv.cycle - lsv.cycle) + asv.day - lsv.day + asv.visit_window,
        lsv.actual_visit_date
    )
            END < 'now'::text::date THEN 'Y'::text
            WHEN lsv.actual_visit_date < 'now'::text::date THEN 'N'::text
            WHEN asv.sm_code::text LIKE '%SM13%'::text OR asv.labcorp_pvc::text = 'BMAMRDSLID'::text THEN 'N'::text
            ELSE NULL::text
        END AS pot_missing, 
        CASE
            WHEN asv.sm_code::text LIKE '%SM13%'::text OR asv.labcorp_pvc::text = 'BMAMRDSLID'::text THEN 'N'::text
            WHEN asv.not_mapped::text = 'Y'::text OR 
            CASE
                WHEN asv.specimen_id IS NOT NULL THEN 'Y'::text
                ELSE 'N'::text
            END = 'N'::text THEN 'Y'::text
            ELSE 'N'::text
        END AS review_item, md5((((((((asv.protocol_id::text || asv.site_id::text) || asv.subject_id::text) || COALESCE(asv.labcorp_pvc, ''::character varying)::text) || COALESCE(asv.visit_name, ''::character varying)::text) || COALESCE(asv.container_number, 0)::text) || COALESCE(asv.specimen_id, ''::character varying)::text) || COALESCE(asv.sm_description, ''::character varying)::text) || COALESCE(asv.visit_id, ''::character varying)::text) AS row_id
   FROM (
    SELECT 
        study.therapeutic_area AS ta,
        study_subject.study_id AS protocol_id,
        study_subject.subject_id,
        study_subject.study_subject_status AS subject_status,
        study_subject.study_arm,
        site.site_country_name AS country,
        site.site_name,
        site.investigator_name AS pi_name,
        es.cohort,
        COALESCE(es.labcorp_pvc, rs.visit_id) AS labcorp_pvc,
        COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid,
        es.label_line_1,
        COALESCE(es.sm_code, rs.sm_code) AS sm_code,
        COALESCE(es.sm_description, rs.sm_description) AS sm_description,
        rs.accession_number,
        COALESCE(es.container_number, rs.container_number) AS container_number,
        rs.receipt_temperature,
        rs.shipping_datetime,
        rs.shipping_destination,
        rs.sample_type,
        rs.specimen_collection_date AS collection_datetime,
        rv.visit_date_actl AS actual_visit_date,
        study_subject.site_id,
        ev.visit_window,
        es.aliquot,
        rs.specimen_id,
        rs.latest_modified_time,
        rv.visit_name AS visit_id,
        es.mandatory,
        NULL AS sample_manual_flag,  
        COALESCE(ev.cycle, rv.cycle) AS cycle,
        COALESCE(ev.day, rv.day) AS day,
                CASE
                    WHEN ev.cc_customized = true THEN (COALESCE(ev.labcorp_pvc_description, rv.visit_name)::text || COALESCE(' - '::text || ev.visit_name::text, ''::text))::character varying
                    ELSE COALESCE(ev.labcorp_pvc_description, rv.visit_name)
                END AS visit_name, 
                CASE
                    WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                    ELSE 'N'::text
                END::character varying AS not_mapped
           FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS sample_type, specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, replace(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                   FROM CERBA.specimen specimen
              JOIN CERBA.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
         LEFT JOIN CERBA.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
      FULL JOIN ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                   FROM (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                           FROM CERBA.study_subject study_subject
                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.visit v
                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                              FROM CERBA.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1))
              UNION ALL 
                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle< lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
           WHERE ev.visit_oid::text <> 'SCREEN'::text
                UNION ALL 
                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                           FROM CERBA.study_subject study_subject
                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.visit v
                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                              FROM CERBA.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                UNION ALL 
                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                           FROM CERBA.study_subject study_subject
                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                   END::integer AS cycle, 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                   END::integer AS day
                              FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
              JOIN CERBA.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es.region::text = evs.region::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es ON es.subject_id::text = rs.subject_id AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number
   LEFT JOIN (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
              FROM CERBA.study_subject study_subject
         LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
    LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS cycle, 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS day
                         FROM CERBA.visit v
                    JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
            JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.visit v
                            JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                    LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                 FROM CERBA.site_amendment
                                WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                   WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                   GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
           WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
   JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                         END::integer AS cycle, 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                         END::integer AS day
                    FROM CERBA.expected_visits ev) expected_visits
           WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                    FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                 END::integer AS cycle, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                 END::integer AS day
                            FROM CERBA.expected_visits ev) expected_visits
                   WHERE expected_visits.amendment = 1))
 UNION ALL 
          SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                         END::integer AS cycle, 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                         END::integer AS day
                    FROM CERBA.expected_visits ev) expected_visits
           WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
  WHERE ev.visit_oid::text <> 'SCREEN'::text
   UNION ALL 
            SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
              FROM CERBA.study_subject study_subject
         LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
    LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS cycle, 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS day
                         FROM CERBA.visit v
                    JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
            JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.visit v
                            JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                    LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                 FROM CERBA.site_amendment
                                WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                   WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                   GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
           WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
   JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                         END::integer AS cycle, 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                         END::integer AS day
                    FROM CERBA.expected_visits ev) expected_visits
           WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
  WHERE ev.visit_oid::text <> 'SCREEN'::text)
   UNION ALL 
            SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
              FROM CERBA.study_subject study_subject
         LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
    JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                      CASE
                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                      END::integer AS cycle, 
                      CASE
                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                      END::integer AS day
                 FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
   WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND ev.labcorp_pvc::text = COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text
   LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
              CASE
                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
              END::integer AS cycle, 
              CASE
                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
              END::integer AS day
         FROM CERBA.visit v
    JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND (rv.cycle IS NOT NULL OR rv.visit_oid::text = 'SCREEN'::text OR rs.specimen_collection_date IS NULL OR date(rs.specimen_collection_date) = rv.visit_date_actl) AND rv.visit_oid::text = ev.visit_oid::text
   LEFT JOIN CERBA.study_subject study_subject ON COALESCE(rv.subject_id, rs.subject_id::character varying, es.subject_id)::text = study_subject.subject_id::text
   LEFT JOIN CERBA.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN CERBA.study ON study.study_id::text = study_subject.study_id::text
  WHERE COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'DE'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'CRS'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'NTX'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'SARR'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'PSDC'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'MMR'::text OR (EXISTS ( SELECT 1
   FROM ( SELECT rs.subject_id, rs.specimen_collection_date, rs.visit_id AS labcorp_pvc
           FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS sample_type, specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, replace(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                   FROM CERBA.specimen specimen
              JOIN CERBA.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
         LEFT JOIN CERBA.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
          WHERE rs.visit_id = 'CRS'::text OR rs.visit_id = 'NTX'::text OR rs.visit_id = 'SARR'::text OR rs.visit_id = 'PSDC'::text OR rs.visit_id = 'MMR'::text) rc
  WHERE rc.subject_id = study_subject.subject_id::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text = rc.labcorp_pvc AND (rv.visit_date_actl IS NULL OR abs(DATEDIFF('day', rc.specimen_collection_date, rv.visit_date_actl)) <= 1)))
UNION ALL 
         SELECT study.therapeutic_area AS ta, study_subject.study_id AS protocol_id, study_subject.subject_id, study_subject.study_subject_status AS subject_status, study_subject.study_arm, site.site_country_name AS country, site.site_name, site.investigator_name AS pi_name, es.cohort, COALESCE(es.labcorp_pvc, rs.visit_id::character varying) AS labcorp_pvc, COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid, es.label_line_1, COALESCE(es.sm_code, rs.sm_code) AS sm_code, COALESCE(es.sm_description, rs.sm_description) AS sm_description, rs.accession_number, COALESCE(es.container_number, rs.container_number) AS container_number, rs.receipt_temperature, rs.shipping_datetime, rs.shipping_destination, rs.sample_type, rs.specimen_collection_date AS collection_datetime, rv.visit_date_actl AS actual_visit_date, study_subject.site_id, 7 AS visit_window, es.aliquot, rs.specimen_id, rs.latest_modified_time, rv.visit_name AS visit_id, es.mandatory, es.cycle, es.day, NULL AS sample_manual_flag, COALESCE(ev.labcorp_pvc_description, rv.visit_name) AS visit_name, 
                CASE
                    WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                    ELSE 'N'::text
                END::character varying AS not_mapped
           FROM ( SELECT es.subject_id, es.labcorp_pvc, ev.labcorp_pvc_description, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort, ev.visit_oid, ev.cycle, ev.day, 7 AS visit_window
                   FROM ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                           FROM (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                      FROM CERBA.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1))
                      UNION ALL 
                               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
                   WHERE ev.visit_oid::text <> 'SCREEN'::text
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                      FROM CERBA.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
                   WHERE ev.visit_oid::text <> 'SCREEN'::text)
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
                      JOIN CERBA.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es.region::text = evs.region::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es
              LEFT JOIN (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                           FROM CERBA.study_subject study_subject
                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.visit v
                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                              FROM CERBA.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1))
              UNION ALL 
                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
           WHERE ev.visit_oid::text <> 'SCREEN'::text
                UNION ALL 
                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                           FROM CERBA.study_subject study_subject
                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.visit v
                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                              FROM CERBA.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                UNION ALL 
                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                           FROM CERBA.study_subject study_subject
                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                   END::integer AS cycle, 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                   END::integer AS day
                              FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = es.subject_id::text
             WHERE es.labcorp_pvc::text = 'DE'::text AND (ev.day = 1 OR ev.labcorp_pvc::text = 'DE'::text)) es
      LEFT JOIN (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                   FROM CERBA.study_subject study_subject
              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                   CASE
                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                   END::integer AS cycle, 
                                   CASE
                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                   END::integer AS day
                              FROM CERBA.visit v
                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.visit v
                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                      FROM CERBA.site_amendment
                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS cycle, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS day
                         FROM CERBA.expected_visits ev) expected_visits
                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 1))
      UNION ALL 
               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS cycle, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS day
                         FROM CERBA.expected_visits ev) expected_visits
                WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
   WHERE ev.visit_oid::text <> 'SCREEN'::text
        UNION ALL 
                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                   FROM CERBA.study_subject study_subject
              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                   CASE
                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                   END::integer AS cycle, 
                                   CASE
                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                   END::integer AS day
                              FROM CERBA.visit v
                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.visit v
                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                      FROM CERBA.site_amendment
                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS cycle, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS day
                         FROM CERBA.expected_visits ev) expected_visits
                WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
   WHERE ev.visit_oid::text <> 'SCREEN'::text)
        UNION ALL 
                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                   FROM CERBA.study_subject study_subject
              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                           CASE
                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                           END::integer AS cycle, 
                           CASE
                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                           END::integer AS day
                      FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON es.subject_id::text = ev.subject_id::text AND es.labcorp_pvc::text = ev.labcorp_pvc::text
   LEFT JOIN ( SELECT received_deval_day1.visit_oid, received_deval_day1.subject_id, received_deval_day1.visit_date_actl, received_deval_day1.visit_name, received_deval_day1.cycle, received_deval_day1.day, received_deval_day1.rn
              FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1.cycle, derived_table1.day, derived_table1.rn
                      FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv.cycle, rv.day, row_number()
                             OVER( 
                             PARTITION BY v.subject_id, rv.cycle
                             ORDER BY DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl)) AS rn
                              FROM CERBA.visit v
                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                    LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.visit v
                            JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl) AND DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl) <= 7
                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv.day = 1) derived_table1
                     WHERE derived_table1.rn = 1) received_deval_day1
   UNION ALL 
            SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, NULL::integer AS cycle, NULL::integer AS day, NULL::integer AS rn
              FROM CERBA.visit v
         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND NOT ((v.subject_id, v.visit_name) IN ( SELECT received_deval_day1.subject_id, received_deval_day1.visit_name
                 FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1.cycle, derived_table1.day, derived_table1.rn
                         FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv.cycle, rv.day, row_number()
                                OVER( 
                                PARTITION BY v.subject_id, rv.cycle
                                ORDER BY DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl)) AS rn
                                 FROM CERBA.visit v
                            JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                       LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                         CASE
                                             WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                         END::integer AS cycle, 
                                         CASE
                                             WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                         END::integer AS day
                                    FROM CERBA.visit v
                               JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                              WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl) AND DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl) <= 7
                      WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv.day = 1) derived_table1
                        WHERE derived_table1.rn = 1) received_deval_day1))) rv ON rv.subject_id::text = es.subject_id::text AND (rv.cycle = es.cycle OR rv.cycle IS NULL AND es.cycle IS NULL)
   LEFT JOIN ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS sample_type, specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, replace(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
         FROM CERBA.specimen specimen
    JOIN CERBA.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
   LEFT JOIN CERBA.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs ON rs.subject_id = es.subject_id::text AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number AND abs(DATEDIFF('day', rs.specimen_collection_date, rv.visit_date_actl)) <= 1
   LEFT JOIN CERBA.study_subject study_subject ON es.subject_id::text = study_subject.subject_id::text
   LEFT JOIN CERBA.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN CERBA.study ON study.study_id::text = study_subject.study_id::text) asv
   LEFT JOIN ( SELECT DISTINCT asv.subject_id, asv.cycle, asv.day, latest.actual_visit_date
           FROM ( SELECT study.therapeutic_area AS ta, study_subject.study_id AS protocol_id, study_subject.subject_id, study_subject.study_subject_status AS subject_status, study_subject.study_arm, site.site_country_name AS country, site.site_name, site.investigator_name AS pi_name, es.cohort, COALESCE(es.labcorp_pvc, rs.visit_id::character varying) AS labcorp_pvc, COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid, es.label_line_1, COALESCE(es.sm_code, rs.sm_code) AS sm_code, COALESCE(es.sm_description, rs.sm_description) AS sm_description, rs.accession_number, COALESCE(es.container_number, rs.container_number) AS container_number, rs.receipt_temperature, rs.shipping_datetime, rs.shipping_destination, rs.sample_type, rs.specimen_collection_date AS collection_datetime, rv.visit_date_actl AS actual_visit_date, study_subject.site_id, ev.visit_window, es.aliquot, rs.specimen_id, rs.latest_modified_time, rv.visit_name AS visit_id, es.mandatory, NULL  AS sample_manual_flag, COALESCE(ev.cycle, rv.cycle) AS cycle, COALESCE(ev.day, rv.day) AS day, 
                        CASE
                            WHEN ev.cc_customized = true THEN (COALESCE(ev.labcorp_pvc_description, rv.visit_name)::text || COALESCE(' - '::text || ev.visit_name::text, ''::text))::character varying
                            ELSE COALESCE(ev.labcorp_pvc_description, rv.visit_name)
                        END AS visit_name, 
                        CASE
                            WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                            ELSE 'N'::text
                        END::character varying AS not_mapped
                   FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS sample_type, specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, replace(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                           FROM CERBA.specimen specimen
                      JOIN CERBA.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
                 LEFT JOIN CERBA.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
              FULL JOIN ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                           FROM (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                      FROM CERBA.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1))
                      UNION ALL 
                               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
                   WHERE ev.visit_oid::text <> 'SCREEN'::text
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                      FROM CERBA.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
                   WHERE ev.visit_oid::text <> 'SCREEN'::text)
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
                      JOIN CERBA.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es.region::text = evs.region::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es ON es.subject_id::text = rs.subject_id AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number
         LEFT JOIN (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                      FROM CERBA.study_subject study_subject
                 LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
            LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.visit v
                            JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                    JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.visit v
                                    JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                            LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                         FROM CERBA.site_amendment
                                        WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                        GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                           WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                           GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                   WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
       JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                    FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                 END::integer AS cycle, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                 END::integer AS day
                            FROM CERBA.expected_visits ev) expected_visits
                   WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                         END::integer AS cycle, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                         END::integer AS day
                                    FROM CERBA.expected_visits ev) expected_visits
                           WHERE expected_visits.amendment = 1))
         UNION ALL 
                  SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                    FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                 END::integer AS cycle, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                 END::integer AS day
                            FROM CERBA.expected_visits ev) expected_visits
                   WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
      WHERE ev.visit_oid::text <> 'SCREEN'::text
           UNION ALL 
                    SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                      FROM CERBA.study_subject study_subject
                 LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
            LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.visit v
                            JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                    JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.visit v
                                    JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                            LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                         FROM CERBA.site_amendment
                                        WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                        GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                           WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                           GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                   WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
       JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                    FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                 END::integer AS cycle, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                 END::integer AS day
                            FROM CERBA.expected_visits ev) expected_visits
                   WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
      WHERE ev.visit_oid::text <> 'SCREEN'::text)
           UNION ALL 
                    SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                      FROM CERBA.study_subject study_subject
                 LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
            JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS cycle, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS day
                         FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
           WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND ev.labcorp_pvc::text = COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text
    LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                      CASE
                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                      END::integer AS cycle, 
                      CASE
                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                      END::integer AS day
                 FROM CERBA.visit v
            JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND (rv.cycle IS NOT NULL OR rv.visit_oid::text = 'SCREEN'::text OR rs.specimen_collection_date IS NULL OR date(rs.specimen_collection_date) = rv.visit_date_actl) AND rv.visit_oid::text = ev.visit_oid::text
   LEFT JOIN CERBA.study_subject study_subject ON COALESCE(rv.subject_id, rs.subject_id::character varying, es.subject_id)::text = study_subject.subject_id::text
   LEFT JOIN CERBA.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN CERBA.study ON study.study_id::text = study_subject.study_id::text
  WHERE COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'DE'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'CRS'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'NTX'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'SARR'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'PSDC'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'MMR'::text OR (EXISTS ( SELECT 1
   FROM ( SELECT rs.subject_id, rs.specimen_collection_date, rs.visit_id AS labcorp_pvc
           FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS sample_type, specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, replace(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                   FROM CERBA.specimen specimen
              JOIN CERBA.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
         LEFT JOIN CERBA.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
          WHERE rs.visit_id = 'CRS'::text OR rs.visit_id = 'NTX'::text OR rs.visit_id = 'SARR'::text OR rs.visit_id = 'PSDC'::text OR rs.visit_id = 'MMR'::text) rc
  WHERE rc.subject_id = study_subject.subject_id::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text = rc.labcorp_pvc AND (rv.visit_date_actl IS NULL OR abs(datediff('day', rc.specimen_collection_date, rv.visit_date_actl)) <= 1)))
        UNION ALL 
                 SELECT study.therapeutic_area AS ta, study_subject.study_id AS protocol_id, study_subject.subject_id, study_subject.study_subject_status AS subject_status, study_subject.study_arm, site.site_country_name AS country, site.site_name, site.investigator_name AS pi_name, es.cohort, COALESCE(es.labcorp_pvc, rs.visit_id::character varying) AS labcorp_pvc, COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid, es.label_line_1, COALESCE(es.sm_code, rs.sm_code) AS sm_code, COALESCE(es.sm_description, rs.sm_description) AS sm_description, rs.accession_number, COALESCE(es.container_number, rs.container_number) AS container_number, rs.receipt_temperature, rs.shipping_datetime, rs.shipping_destination, rs.sample_type, rs.specimen_collection_date AS collection_datetime, rv.visit_date_actl AS actual_visit_date, study_subject.site_id, 7 AS visit_window, es.aliquot, rs.specimen_id, rs.latest_modified_time, rv.visit_name AS visit_id, es.mandatory, es.cycle, es.day, NULL AS sample_manual_flag, COALESCE(ev.labcorp_pvc_description, rv.visit_name) AS visit_name, 
                        CASE
                            WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                            ELSE 'N'::text
                        END::character varying AS not_mapped
                   FROM ( SELECT es.subject_id, es.labcorp_pvc, ev.labcorp_pvc_description, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort, ev.visit_oid, ev.cycle, ev.day, 7 AS visit_window
                           FROM ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                                   FROM (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                           FROM CERBA.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS cycle, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS day
                                                              FROM CERBA.visit v
                                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                              FROM CERBA.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS cycle, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS day
                                                         FROM CERBA.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 1))
                              UNION ALL 
                                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
                           WHERE ev.visit_oid::text <> 'SCREEN'::text
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                           FROM CERBA.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS cycle, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS day
                                                              FROM CERBA.visit v
                                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                              FROM CERBA.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
                           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                           FROM CERBA.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
                              JOIN CERBA.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es.region::text = evs.region::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es
                      LEFT JOIN (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                      FROM CERBA.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1))
                      UNION ALL 
                               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
                   WHERE ev.visit_oid::text <> 'SCREEN'::text
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                      FROM CERBA.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
                   WHERE ev.visit_oid::text <> 'SCREEN'::text)
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = es.subject_id::text
                     WHERE es.labcorp_pvc::text = 'DE'::text AND (ev.day = 1 OR ev.labcorp_pvc::text = 'DE'::text)) es
              LEFT JOIN (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                           FROM CERBA.study_subject study_subject
                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.visit v
                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                              FROM CERBA.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1))
              UNION ALL 
                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
           WHERE ev.visit_oid::text <> 'SCREEN'::text
                UNION ALL 
                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                           FROM CERBA.study_subject study_subject
                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.visit v
                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                              FROM CERBA.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                UNION ALL 
                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                           FROM CERBA.study_subject study_subject
                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                   END::integer AS cycle, 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                   END::integer AS day
                              FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON es.subject_id::text = ev.subject_id::text AND es.labcorp_pvc::text = ev.labcorp_pvc::text
         LEFT JOIN ( SELECT received_deval_day1.visit_oid, received_deval_day1.subject_id, received_deval_day1.visit_date_actl, received_deval_day1.visit_name, received_deval_day1.cycle, received_deval_day1.day, received_deval_day1.rn
                      FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1.cycle, derived_table1.day, derived_table1.rn
                              FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv.cycle, rv.day, row_number()
                                     OVER( 
                                     PARTITION BY v.subject_id, rv.cycle
                                     ORDER BY datediff('day', rv.visit_date_actl, v.visit_date_actl)) AS rn
                                      FROM CERBA.visit v
                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                            LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.visit v
                                    JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= datediff('day', rv.visit_date_actl, v.visit_date_actl) AND datediff('day', rv.visit_date_actl, v.visit_date_actl) <= 7
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv.day = 1) derived_table1
                             WHERE derived_table1.rn = 1) received_deval_day1
           UNION ALL 
                    SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, NULL::integer AS cycle, NULL::integer AS day, NULL::integer AS rn
                      FROM CERBA.visit v
                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND NOT ((v.subject_id, v.visit_name) IN ( SELECT received_deval_day1.subject_id, received_deval_day1.visit_name
                         FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1.cycle, derived_table1.day, derived_table1.rn
                                 FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv.cycle, rv.day, row_number()
                                        OVER( 
                                        PARTITION BY v.subject_id, rv.cycle
                                        ORDER BY datediff('day', rv.visit_date_actl, v.visit_date_actl)) AS rn
                                         FROM CERBA.visit v
                                    JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                               LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                 CASE
                                                     WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                     ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                 END::integer AS cycle, 
                                                 CASE
                                                     WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                     ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                 END::integer AS day
                                            FROM CERBA.visit v
                                       JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                      WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= datediff('day', rv.visit_date_actl, v.visit_date_actl) AND DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl) <= 7
                              WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv.day = 1) derived_table1
                                WHERE derived_table1.rn = 1) received_deval_day1))) rv ON rv.subject_id::text = es.subject_id::text AND (rv.cycle = es.cycle OR rv.cycle IS NULL AND es.cycle IS NULL)
    LEFT JOIN ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS sample_type, specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, replace(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                 FROM CERBA.specimen specimen
            JOIN CERBA.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
       LEFT JOIN CERBA.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs ON rs.subject_id = es.subject_id::text AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number AND abs(DATEDIFF('day', rs.specimen_collection_date, rv.visit_date_actl)) <= 1
   LEFT JOIN CERBA.study_subject study_subject ON es.subject_id::text = study_subject.subject_id::text
   LEFT JOIN CERBA.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN CERBA.study ON study.study_id::text = study_subject.study_id::text) asv
      JOIN ( SELECT all_samples_visits.subject_id, max(all_samples_visits.actual_visit_date) AS actual_visit_date
                   FROM ( SELECT study.therapeutic_area AS ta, study_subject.study_id AS protocol_id, study_subject.subject_id, study_subject.study_subject_status AS subject_status, study_subject.study_arm, site.site_country_name AS country, site.site_name, site.investigator_name AS pi_name, es.cohort, COALESCE(es.labcorp_pvc, rs.visit_id::character varying) AS labcorp_pvc, COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid, es.label_line_1, COALESCE(es.sm_code, rs.sm_code) AS sm_code, COALESCE(es.sm_description, rs.sm_description) AS sm_description, rs.accession_number, COALESCE(es.container_number, rs.container_number) AS container_number, rs.receipt_temperature, rs.shipping_datetime, rs.shipping_destination, rs.sample_type, rs.specimen_collection_date AS collection_datetime, rv.visit_date_actl AS actual_visit_date, study_subject.site_id, ev.visit_window, es.aliquot, rs.specimen_id, rs.latest_modified_time, rv.visit_name AS visit_id, es.mandatory, NULL AS sample_manual_flag, COALESCE(ev.cycle, rv.cycle) AS cycle, COALESCE(ev.day, rv.day) AS day, 
                                CASE
                                    WHEN ev.cc_customized = true THEN (COALESCE(ev.labcorp_pvc_description, rv.visit_name)::text || COALESCE(' - '::text || ev.visit_name::text, ''::text))::character varying
                                    ELSE COALESCE(ev.labcorp_pvc_description, rv.visit_name)
                                END AS visit_name, 
                                CASE
                                    WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                                    ELSE 'N'::text
                                END::character varying AS not_mapped
                           FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS sample_type, specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, replace(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                                   FROM CERBA.specimen specimen
                              JOIN CERBA.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
                         LEFT JOIN CERBA.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
                      FULL JOIN ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                                   FROM (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                           FROM CERBA.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS cycle, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS day
                                                              FROM CERBA.visit v
                                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                              FROM CERBA.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS cycle, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS day
                                                         FROM CERBA.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 1))
                              UNION ALL 
                                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
                           WHERE ev.visit_oid::text <> 'SCREEN'::text
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                           FROM CERBA.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS cycle, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS day
                                                              FROM CERBA.visit v
                                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                              FROM CERBA.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
                           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                           FROM CERBA.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
                              JOIN CERBA.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es.region::text = evs.region::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es ON es.subject_id::text = rs.subject_id AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number
                 LEFT JOIN (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                              FROM CERBA.study_subject study_subject
                         LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                    LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.visit v
                                    JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                            JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.visit v
                                            JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                    LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                 FROM CERBA.site_amendment
                                                WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                   WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                   GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                           WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
               JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                         END::integer AS cycle, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                         END::integer AS day
                                    FROM CERBA.expected_visits ev) expected_visits
                           WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                    FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                 CASE
                                                     WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                     ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                 END::integer AS cycle, 
                                                 CASE
                                                     WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                     ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                 END::integer AS day
                                            FROM CERBA.expected_visits ev) expected_visits
                                   WHERE expected_visits.amendment = 1))
                 UNION ALL 
                          SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                         END::integer AS cycle, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                         END::integer AS day
                                    FROM CERBA.expected_visits ev) expected_visits
                           WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
              WHERE ev.visit_oid::text <> 'SCREEN'::text
                   UNION ALL 
                            SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                              FROM CERBA.study_subject study_subject
                         LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                    LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.visit v
                                    JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                            JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.visit v
                                            JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                    LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                 FROM CERBA.site_amendment
                                                WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                   WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                   GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                           WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
               JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                         END::integer AS cycle, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                         END::integer AS day
                                    FROM CERBA.expected_visits ev) expected_visits
                           WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
              WHERE ev.visit_oid::text <> 'SCREEN'::text)
                   UNION ALL 
                            SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                              FROM CERBA.study_subject study_subject
                         LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                    JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS cycle, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS day
                                 FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                   WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND ev.labcorp_pvc::text = COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text
            LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS cycle, 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS day
                         FROM CERBA.visit v
                    JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND (rv.cycle IS NOT NULL OR rv.visit_oid::text = 'SCREEN'::text OR rs.specimen_collection_date IS NULL OR date(rs.specimen_collection_date) = rv.visit_date_actl) AND rv.visit_oid::text = ev.visit_oid::text
       LEFT JOIN CERBA.study_subject study_subject ON COALESCE(rv.subject_id, rs.subject_id::character varying, es.subject_id)::text = study_subject.subject_id::text
   LEFT JOIN CERBA.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN CERBA.study ON study.study_id::text = study_subject.study_id::text
  WHERE COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'DE'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'CRS'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'NTX'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'SARR'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'PSDC'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'MMR'::text OR (EXISTS ( SELECT 1
     FROM ( SELECT rs.subject_id, rs.specimen_collection_date, rs.visit_id AS labcorp_pvc
             FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS sample_type, specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, replace(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                     FROM CERBA.specimen specimen
                JOIN CERBA.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
           LEFT JOIN CERBA.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
            WHERE rs.visit_id = 'CRS'::text OR rs.visit_id = 'NTX'::text OR rs.visit_id = 'SARR'::text OR rs.visit_id = 'PSDC'::text OR rs.visit_id = 'MMR'::text) rc
    WHERE rc.subject_id = study_subject.subject_id::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text = rc.labcorp_pvc AND (rv.visit_date_actl IS NULL OR abs(DATEDIFF('day', rc.specimen_collection_date, rv.visit_date_actl)) <= 1)))
                UNION ALL 
                         SELECT study.therapeutic_area AS ta, study_subject.study_id AS protocol_id, study_subject.subject_id, study_subject.study_subject_status AS subject_status, study_subject.study_arm, site.site_country_name AS country, site.site_name, site.investigator_name AS pi_name, es.cohort, COALESCE(es.labcorp_pvc, rs.visit_id::character varying) AS labcorp_pvc, COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid, es.label_line_1, COALESCE(es.sm_code, rs.sm_code) AS sm_code, COALESCE(es.sm_description, rs.sm_description) AS sm_description, rs.accession_number, COALESCE(es.container_number, rs.container_number) AS container_number, rs.receipt_temperature, rs.shipping_datetime, rs.shipping_destination, rs.sample_type, rs.specimen_collection_date AS collection_datetime, rv.visit_date_actl AS actual_visit_date, study_subject.site_id, 7 AS visit_window, es.aliquot, rs.specimen_id, rs.latest_modified_time, rv.visit_name AS visit_id, es.mandatory, es.cycle, es.day, NULL  AS sample_manual_flag, COALESCE(ev.labcorp_pvc_description, rv.visit_name) AS visit_name, 
                                CASE
                                    WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                                    ELSE 'N'::text
                                END::character varying AS not_mapped
                           FROM ( SELECT es.subject_id, es.labcorp_pvc, ev.labcorp_pvc_description, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort, ev.visit_oid, ev.cycle, ev.day, 7 AS visit_window
                                   FROM ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                                           FROM (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                                   FROM CERBA.study_subject study_subject
                                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS cycle, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS day
                                                              FROM CERBA.visit v
                                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                           CASE
                                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                           END::integer AS cycle, 
                                                                           CASE
                                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                           END::integer AS day
                                                                      FROM CERBA.visit v
                                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                                      FROM CERBA.site_amendment
                                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS cycle, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS day
                                                         FROM CERBA.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                                      CASE
                                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                      END::integer AS cycle, 
                                                                      CASE
                                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                      END::integer AS day
                                                                 FROM CERBA.expected_visits ev) expected_visits
                                                        WHERE expected_visits.amendment = 1))
                                      UNION ALL 
                                               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS cycle, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS day
                                                         FROM CERBA.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
                                   WHERE ev.visit_oid::text <> 'SCREEN'::text
                                        UNION ALL 
                                                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                                   FROM CERBA.study_subject study_subject
                                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS cycle, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS day
                                                              FROM CERBA.visit v
                                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                           CASE
                                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                           END::integer AS cycle, 
                                                                           CASE
                                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                           END::integer AS day
                                                                      FROM CERBA.visit v
                                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                                      FROM CERBA.site_amendment
                                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS cycle, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS day
                                                         FROM CERBA.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
                                   WHERE ev.visit_oid::text <> 'SCREEN'::text)
                                        UNION ALL 
                                                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                                   FROM CERBA.study_subject study_subject
                                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                           CASE
                                                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                                        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
                                      JOIN CERBA.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es.region::text = evs.region::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es
                              LEFT JOIN (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                           FROM CERBA.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS cycle, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS day
                                                              FROM CERBA.visit v
                                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                              FROM CERBA.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS cycle, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS day
                                                         FROM CERBA.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 1))
                              UNION ALL 
                                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
                           WHERE ev.visit_oid::text <> 'SCREEN'::text
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                           FROM CERBA.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS cycle, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS day
                                                              FROM CERBA.visit v
                                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                              FROM CERBA.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                                WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
                           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                           FROM CERBA.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = es.subject_id::text
                             WHERE es.labcorp_pvc::text = 'DE'::text AND (ev.day = 1 OR ev.labcorp_pvc::text = 'DE'::text)) es
                      LEFT JOIN (( SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                      FROM CERBA.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits.region, expected_visits.study_arm
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1))
                      UNION ALL 
                               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND ev.cycle IS NOT NULL AND (ev.cycle < lav.cycle OR ev.cycle = lav.cycle AND ev.day <= lav.day)
                   WHERE ev.visit_oid::text <> 'SCREEN'::text
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv.cycle, rv.day
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS cycle, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS day
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, max(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS cycle, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS day
                                                      FROM CERBA.visit v
                                                 JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, max(site_amendment.date_updated) AS date_updated
                                                      FROM CERBA.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON right(sad.site_id::text, 7) = left(rv.subject_id::text, 7)
                                        WHERE rv.cycle IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv.cycle IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits.region, expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits.cycle, expected_visits.day
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS cycle, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS day
                                         FROM CERBA.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2) ev ON ev.region::text = country_region.region::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev.cycle IS NULL OR lav.cycle IS NULL OR lav.day IS NULL OR ev.cycle > lav.cycle OR ev.cycle = lav.cycle AND ev.day > lav.day)
                   WHERE ev.visit_oid::text <> 'SCREEN'::text)
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev.region, ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev.cycle, ev.day, ev.cc_customized
                                   FROM CERBA.study_subject study_subject
                              LEFT JOIN orbit.country_region ON left(study_subject.subject_id::text, 2) = country_region.country::text
                         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev.region, ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS cycle, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS day
                                      FROM CERBA.expected_visits ev) ev ON ev.region::text = country_region.region::text
                        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON es.subject_id::text = ev.subject_id::text AND es.labcorp_pvc::text = ev.labcorp_pvc::text
                 LEFT JOIN ( SELECT received_deval_day1.visit_oid, received_deval_day1.subject_id, received_deval_day1.visit_date_actl, received_deval_day1.visit_name, received_deval_day1.cycle, received_deval_day1.day, received_deval_day1.rn
                              FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1.cycle, derived_table1.day, derived_table1.rn
                                      FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv.cycle, rv.day, row_number()
                                             OVER( 
                                             PARTITION BY v.subject_id, rv.cycle
                                             ORDER BY DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl)) AS rn
                                              FROM CERBA.visit v
                                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                    LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS cycle, 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS day
                                                 FROM CERBA.visit v
                                            JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl) AND DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl) <= 7
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv.day = 1) derived_table1
                                     WHERE derived_table1.rn = 1) received_deval_day1
                   UNION ALL 
                            SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, NULL::integer AS cycle, NULL::integer AS day, NULL::integer AS rn
                              FROM CERBA.visit v
                         JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND NOT ((v.subject_id, v.visit_name) IN ( SELECT received_deval_day1.subject_id, received_deval_day1.visit_name
                                 FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1.cycle, derived_table1.day, derived_table1.rn
                                         FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv.cycle, rv.day, row_number()
                                                OVER( 
                                                PARTITION BY v.subject_id, rv.cycle
                                                ORDER BY DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl)) AS rn
                                                 FROM CERBA.visit v
                                            JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                       LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                         CASE
                                                             WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                             ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                         END::integer AS cycle, 
                                                         CASE
                                                             WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                             ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                         END::integer AS day
                                                    FROM CERBA.visit v
                                               JOIN CERBA.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                              WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl) AND DATEDIFF('day', rv.visit_date_actl, v.visit_date_actl::timestamp without time zone) <= 7
                                      WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv.day = 1) derived_table1
                                        WHERE derived_table1.rn = 1) received_deval_day1))) rv ON rv.subject_id::text = es.subject_id::text AND (rv.cycle = es.cycle OR rv.cycle IS NULL AND es.cycle IS NULL)
            LEFT JOIN ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS sample_type, specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, replace(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                         FROM CERBA.specimen specimen
                    JOIN CERBA.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
               LEFT JOIN CERBA.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs ON rs.subject_id = es.subject_id::text AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number AND abs(DATEDIFF('day', rs.specimen_collection_date, rv.visit_date_actl)) <= 1
       LEFT JOIN CERBA.study_subject study_subject ON es.subject_id::text = study_subject.subject_id::text
   LEFT JOIN CERBA.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN CERBA.study ON study.study_id::text = study_subject.study_id::text) all_samples_visits
                  WHERE all_samples_visits.cycle IS NOT NULL AND all_samples_visits.day IS NOT NULL
                  GROUP BY all_samples_visits.subject_id) latest ON asv.subject_id::text = latest.subject_id::text AND asv.actual_visit_date = latest.actual_visit_date
     WHERE asv.cycle IS NOT NULL AND asv.day IS NOT NULL) lsv ON asv.subject_id::text = lsv.subject_id::text
   LEFT JOIN ( SELECT visit.subject_id, visit.visit_date_actl
      FROM CERBA.visit
     WHERE visit.visit_type::text = 'DRM_ZR'::text) rand ON replace(rand.subject_id::text, 'AL8'::text, ''::text) = asv.subject_id::text
   LEFT JOIN ((( SELECT 'Arm A (Tal-P)' AS study_arm, 28 AS cycle_length
UNION ALL 
 SELECT 'Arm B (Tal-Tec)', 28)
UNION ALL 
 SELECT 'Arm C (EPd)', 28)
UNION ALL 
 SELECT 'Arm C (PVd)', 21) acl ON asv.study_arm::text = acl.study_arm::text
   LEFT JOIN ( SELECT received_samples.sm_description, max(received_samples.sample_type::text) AS sample_type
   FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS sample_type, specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, replace(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
           FROM CERBA.specimen specimen
      JOIN CERBA.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
   LEFT JOIN CERBA.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) received_samples
  GROUP BY received_samples.sm_description) rt ON asv.sm_description::text = rt.sm_description::text
  WHERE (asv.mandatory = true AND asv.sm_code::text <> ''::text OR 
CASE
    WHEN asv.specimen_id IS NOT NULL THEN 'Y'::text
    ELSE 'N'::text
END = 'Y'::text) AND (
CASE
    WHEN asv.visit_oid = 'C1D1' THEN DATEADD(day, 7, rand.visit_date_actl)
ELSE DATEADD(
    day,
    acl.cycle_length * (asv.cycle - lsv.cycle) + asv.day - lsv.day + asv.visit_window,
    lsv.actual_visit_date
)
END < 'now'::text::date OR asv.actual_visit_date IS NOT NULL OR asv.collection_datetime IS NOT NULL) AND asv.sm_code::text <> 'SM11/PBMC'::text AND asv.sm_code::text <> 'SM12/MRD BMA'::text;