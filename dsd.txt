-- orbit_64407564mmy3009.shipping_error_vw source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.shipping_error_vw
AS SELECT DISTINCT s.specimen_id, s.accession_number, s.study_subject, s.study_id, s.subject_id, s.pre_screening_id, s.visit_id, s.vendor_id, s.specimen_class, s.specimen_type, s.storage_location, s.storage_state, s.storage_temperature, s.vendor_specimen_id, s.vendor_subject_id, s.vendor_study_id, s.site_specimen_id, s.specimen_condition, s.specimen_extract_location, s.specimen_collection_date, s.specimen_received_date, s.vendor_specimen_type, s.specimen_status, s.specimen_accession_date, s.specimen_reporting_date, s.repeat_status, s.repeat_times, s.number_of_slides, s.number_of_slides_needed, s.reason_qualified_or_failed, s.sample_pass_fail_status, s.run_id, s.composite_primary_key, s.row_id, t.site_id, t.site_name, t.investigator_name, t.site_city, t.site_state, t.site_postcode, t.site_country_code, t.site_country_name, 
        CASE
            WHEN lower(s.specimen_class::text) ~~ '%re-receipt%'::text THEN 'Labcorp Re-Receipt'::text
            ELSE 'Incorrect Destination (Labcorp)'::text
        END AS issue_type
   FROM orbit_64407564mmy3009.specimen s
   JOIN orbit_64407564mmy3009.study_subject ss ON s.subject_id::text = ss.subject_id::text
   LEFT JOIN orbit_64407564mmy3009.site t ON ss.site_id::text = t.site_id::text
  WHERE (lower(s.specimen_class::text) ~~ '%wb%'::text OR lower(s.specimen_class::text) ~~ '%bma%'::text) AND lower(s.specimen_class::text) ~~ '%immunophenotyping%'::text;
