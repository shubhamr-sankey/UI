-- orbit_64407564mmy3009.code_validation_vw source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.code_validation_vw
AS SELECT DISTINCT sid.study_id, v.vendor_name, 'sm_code'::text AS value_type, sp.specimen_type, sp.vendor_specimen_type AS orig_value, 
        CASE
            WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'SM%'::text THEN "substring"(sp.vendor_specimen_type::text, 1, 4)
            WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'HM%'::text THEN "substring"(sp.vendor_specimen_type::text, 1, 4)
            WHEN sp.vendor_id = 3 AND sp.specimen_class::text ~~ 'TBO%'::text THEN "substring"(sp.specimen_class::text, 1, 6)
            WHEN sp.vendor_id = 21 THEN sp.specimen_class::text
            ELSE NULL::text
        END::character varying AS value, c.report_value_type, 
        CASE
            WHEN sp.vendor_id = 3 THEN c.report_value
            WHEN sp.vendor_id = 21 THEN initcap(sp.specimen_type::text)::character varying
            ELSE NULL::character varying
        END AS report_value, sp.specimen_class, NULL::text AS test_name
   FROM orbit_64407564mmy3009.specimen sp
   LEFT JOIN ( SELECT codes_of_interest.study_id, codes_of_interest.value_type, codes_of_interest.value, codes_of_interest.vendor, codes_of_interest.report_value_type, codes_of_interest.report_value
           FROM orbit_64407564mmy3009.codes_of_interest
          WHERE codes_of_interest.value_type::text = 'sm_code'::text) c ON "substring"(sp.vendor_specimen_type::text, 1, 4) = 
   CASE
       WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'SM%'::text THEN c.value
       WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'HM%'::text THEN c.value
       ELSE NULL::character varying
   END::text OR "substring"(sp.specimen_class::text, 1, 6) = 
   CASE
       WHEN sp.vendor_id = 3 AND sp.specimen_class::text ~~ 'TBO%'::text THEN c.value
       ELSE NULL::character varying
   END::text OR sp.vendor_id::text = 
   CASE
       WHEN sp.vendor_id = 21 THEN c.vendor
       ELSE NULL::character varying
   END::text
   JOIN ( SELECT DISTINCT codes_of_interest.study_id
      FROM orbit_64407564mmy3009.codes_of_interest) sid ON 1 = 1
   LEFT JOIN orbit_64407564mmy3009.vendor v ON c.vendor::text = v.vendor_id::text
  WHERE sp.vendor_specimen_type IS NOT NULL AND sp.vendor_id = 3 OR sp.vendor_id = 21
UNION ALL 
 SELECT DISTINCT sid.study_id, v.vendor_name, 'test_code'::text AS value_type, NULL::text AS specimen_type, s.test_code AS orig_value, c.value, c.report_value_type, c.report_value, NULL::text AS specimen_class, s.test_name
   FROM orbit_64407564mmy3009.specimen_test s
   JOIN ( SELECT sp.specimen_id, sp.accession_number, sp.study_subject, sp.study_id, sp.subject_id, sp.pre_screening_id, sp.visit_id, sp.vendor_id, sp.specimen_class, sp.specimen_type, sp.storage_location, sp.storage_state, sp.storage_temperature, sp.vendor_specimen_id, sp.vendor_subject_id, sp.vendor_study_id, sp.site_specimen_id, sp.specimen_condition, sp.specimen_extract_location, sp.specimen_collection_date, sp.specimen_received_date, sp.vendor_specimen_type, sp.specimen_status, sp.specimen_accession_date, sp.specimen_reporting_date, sp.repeat_status, sp.repeat_times, sp.number_of_slides, sp.number_of_slides_needed, sp.reason_qualified_or_failed, sp.sample_pass_fail_status, sp.run_id, sp.composite_primary_key, sp.row_id
           FROM orbit_64407564mmy3009.specimen sp
          WHERE sp.specimen_status IS NOT NULL) sp ON s.specimen_id::text = sp.specimen_id::text AND s.vendor_id = sp.vendor_id
   LEFT JOIN ( SELECT codes_of_interest.study_id, codes_of_interest.value_type, codes_of_interest.value, codes_of_interest.vendor, codes_of_interest.report_value_type, codes_of_interest.report_value
      FROM orbit_64407564mmy3009.codes_of_interest
     WHERE codes_of_interest.value_type::text = 'test_code'::text) c ON s.test_code::text = c.value::text
   LEFT JOIN orbit_64407564mmy3009.vendor v ON c.vendor::text = v.vendor_id::text
   JOIN ( SELECT DISTINCT codes_of_interest.study_id
   FROM orbit_64407564mmy3009.codes_of_interest) sid ON 1 = 1;

________________________________
-- orbit_64407564mmy3009.collection_tracking_vw source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.collection_tracking_vw
AS SELECT DISTINCT ss.subject_id, ss.site_id, s.site_country_name, ss.date_screening, ss.date_screen_failure, ss.date_enrollment, ss.date_termination, ss.study_subject_status, ss.study_arm, ss.study_part, NULL::text AS cohort, v.visit_date_exp, regexp_replace(bps.visit_window::text, '[^0-9]'::text, ''::text)::character varying AS visit_window_days, 
        CASE
            WHEN bps.visit_window::text ~~ '%-%'::text THEN v.visit_date_exp - regexp_replace(bps.visit_window::text, '[^0-9]'::text, ''::text)::integer
            ELSE v.visit_date_exp
        END AS exp_visit_window_min, 
        CASE
            WHEN bps.visit_window::text ~~ '%+%'::text THEN v.visit_date_exp + regexp_replace(bps.visit_window::text, '[^0-9]'::text, ''::text)::integer
            ELSE v.visit_date_exp
        END AS exp_visit_window_max, v.visit_date_actl, v.visit_oid AS v_visit_oid, sp.visit_id AS sp_visit_id, sp.specimen_collection_date, bps."region", bps.vendor_id, vd.vendor_name, bps.visit_oid AS exp_visit, bps.visit_name AS exp_visit_name, bps.arm AS exp_arm, bps.assessment_group, bps.assessment, bps.exp_specimen_type, bps.timepoint, bps.vendor_specimen_type AS exp_specimen_class, bps.specimen_visit_id, concat(concat(bps.visit_name::text, '_'::text), bps.assessment::text)::character varying AS scheduled_collection, sp.specimen_class, sp.specimen_type, sp.accession_number, sp.specimen_id, sp.specimen_received_date, sp.specimen_accession_date, sp.specimen_status, COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) AS past_visit_date, 
        CASE
            WHEN sp.specimen_collection_date IS NOT NULL OR sp.specimen_id IS NOT NULL THEN 'Collected'::text
            WHEN COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) IS NULL AND (COALESCE(
            CASE
                WHEN bps.visit_window::text ~~ '%+%'::text THEN v.visit_date_exp + regexp_replace(bps.visit_window::text, '[^0-9]'::text, ''::text)::integer
                ELSE v.visit_date_exp
            END, v.visit_date_exp) + 7) >= getdate() AND ss.study_subject_status::text <> 'Early Terminated'::text AND ss.study_subject_status::text <> 'Screen Failed'::text THEN 'Future Collection'::text
            WHEN COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) IS NULL AND v.visit_date_exp IS NULL AND ss.study_subject_status::text <> 'Screening'::text AND ss.study_subject_status::text <> 'Early Terminated'::text AND ss.study_subject_status::text <> 'Screen Failed'::text THEN 'Future Collection'::text
            WHEN COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) IS NOT NULL AND getdate() <= (COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) + 7::bigint) THEN 'Pending'::text
            WHEN sp.specimen_collection_date IS NULL AND sp.specimen_id IS NULL AND getdate() > (COALESCE(
            CASE
                WHEN bps.visit_window::text ~~ '%+%'::text THEN v.visit_date_exp + regexp_replace(bps.visit_window::text, '[^0-9]'::text, ''::text)::integer
                ELSE v.visit_date_exp
            END::timestamp without time zone, v.visit_date_exp::timestamp without time zone, COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date)) + 7::bigint) THEN 'Missed Collection'::text
            WHEN COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) IS NULL AND ss.study_subject_status::text = 'Early Terminated'::text AND (v.visit_date_exp >= ss.date_termination OR v.visit_date_exp IS NULL) THEN 'Not Expected'::text
            ELSE NULL::text
        END::character varying AS collection_status, bps.protocol_version, bps.protocol_start_date, bps.protocol_end_date, 
        CASE
            WHEN (ss.study_subject_status::text = 'Screening'::text OR ss.study_subject_status::text = 'Screen Failed'::text) AND bps.visit_oid::text <> 'SCREEN'::text THEN 'remove'::text
            WHEN COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) IS NOT NULL AND COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) >= bps.protocol_start_date AND (COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) <= bps.protocol_end_date OR bps.protocol_end_date IS NULL) THEN 'keep'::text
            WHEN COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) IS NULL AND v.visit_date_exp >= bps.protocol_start_date AND (v.visit_date_exp <= bps.protocol_end_date OR bps.protocol_end_date IS NULL) THEN 'keep'::text
            WHEN COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) IS NULL AND v.visit_date_exp IS NULL AND bps.protocol_end_date IS NULL THEN 'keep'::text
            ELSE 'remove'::text
        END::character varying AS on_protocol, bps.collection_comment
   FROM ( SELECT study_subject.study_id, study_subject.subject_id, study_subject.site_id, study_subject.date_screening, study_subject.date_screen_failure, study_subject.date_enrollment, study_subject.date_termination, study_subject.study_subject_status, study_subject.study_arm, study_subject.study_part
           FROM orbit_64407564mmy3009.study_subject) ss
  CROSS JOIN orbit_64407564mmy3009.biomarker_schedule bps
   LEFT JOIN ( SELECT specimen.subject_id, specimen.visit_id, specimen.specimen_class, specimen.specimen_type, specimen.vendor_specimen_type, specimen.accession_number, specimen.specimen_id, specimen.specimen_collection_date, specimen.specimen_received_date, specimen.specimen_accession_date, specimen.specimen_status, specimen.vendor_id, 
           CASE
               WHEN specimen.vendor_id = 21 AND (specimen.specimen_class::text = 'CYTOF'::text OR specimen.specimen_class::text = 'CYTOF/Molecular Markers'::text) THEN 'CYTOF, CYTOF/Molecular Markers'::character varying
               WHEN specimen.vendor_id = 21 AND specimen.visit_id::text ~~ '%SCREENING'::text AND (specimen.specimen_class::text = 'MRD'::text OR specimen.specimen_class::text = 'ARCHIVAL'::text) THEN 'MRD, ARCHIVAL'::character varying
               WHEN specimen.vendor_id = 21 THEN specimen.specimen_class
               WHEN specimen.vendor_id = 3 THEN "left"(specimen.vendor_specimen_type::text, 4)::character varying
               ELSE specimen.vendor_specimen_type
           END AS spec_type_match, 
           CASE
               WHEN specimen.vendor_id = 21 THEN split_part(specimen.visit_id::text, '|'::text, 2)::character varying
               ELSE specimen.visit_id
           END AS visit_id_match
      FROM orbit_64407564mmy3009.specimen) sp ON ss.subject_id::text = sp.subject_id::text AND upper(bps.specimen_visit_id::text) = upper(sp.visit_id_match::text) AND (bps.vendor_specimen_type::text = sp.spec_type_match::text OR bps.vendor_specimen_type IS NULL)
   LEFT JOIN orbit_64407564mmy3009.study_site sst ON ss.site_id::text = sst.site_id::text AND ss.study_id::text = sst.study_id::text
   LEFT JOIN orbit_64407564mmy3009.site s ON ss.site_id::text = s.site_id::text AND ss.study_id::text = s.study_id::text AND sst.site_country::text = s.site_country_code::text
   LEFT JOIN orbit_64407564mmy3009.vendor vd ON bps.vendor_id::text = vd.vendor_id::text
   LEFT JOIN (( SELECT visit.subject_id, visit.visit_name, visit.visit_oid, visit.visit_date_exp, visit.visit_date_actl, visit.visit_oid AS visit_match
   FROM orbit_64407564mmy3009.visit
UNION 
 SELECT DISTINCT subject_test_response.subject_id, 
        CASE
            WHEN subject_test_response.subject_test_value_description::text ~~ '%Complete Response'::text THEN 'Stringent/Complete Response'::character varying
            ELSE subject_test_response.subject_test_value_description
        END AS visit_name, 
        CASE
            WHEN subject_test_response.subject_test_value::text = 'CR'::text OR subject_test_response.subject_test_value::text = 'sCR'::text THEN 'CR/sCR'::character varying
            ELSE subject_test_response.subject_test_value
        END AS visit_oid, NULL::date AS visit_date_exp, min(subject_test_response.subject_test_date::date)
  OVER( 
  PARTITION BY subject_test_response.subject_id, 
        CASE
            WHEN subject_test_response.subject_test_value::text = 'CR'::text OR subject_test_response.subject_test_value::text = 'sCR'::text THEN 'CR/sCR'::character varying
            ELSE subject_test_response.subject_test_value
        END
  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS visit_date_actl, 
        CASE
            WHEN subject_test_response.subject_test_value::text = 'CR'::text OR subject_test_response.subject_test_value::text = 'sCR'::text THEN 'CR/sCR'::character varying
            ELSE subject_test_response.subject_test_value
        END AS visit_match
   FROM orbit_64407564mmy3009_outcome.subject_test_response
  WHERE subject_test_response.subject_test_name::text = 'Disease Response'::text AND subject_test_response.subject_test_category::text = 'Evaluation of Response (IMWG Criteria)'::text AND (subject_test_response.subject_test_value::text = 'sCR'::text OR subject_test_response.subject_test_value::text = 'CR'::text OR subject_test_response.subject_test_value::text = 'PD'::text))
UNION 
 SELECT derived_table42.subject_id, derived_table42.visit_name, derived_table42.visit_oid, derived_table42.visit_date_exp, derived_table42.visit_date_actl, derived_table42.visit_match
   FROM ( SELECT DISTINCT str.subject_id, v.visit_date_actl AS c1d1_date_actl, fuv.visit_oid AS visit_name, fuv.visit_oid, "substring"(fuv.visit_oid::text, 8, 2)::integer AS months_after_c1d1, date_add('month'::text, "substring"(fuv.visit_oid::text, 8, 2)::integer::bigint, v.visit_date_actl::timestamp without time zone)::date AS visit_date_exp, NULL::date AS visit_date_actl, fuv.visit_oid AS visit_match
           FROM ( SELECT subject_test_response.subject_id
                   FROM orbit_64407564mmy3009_outcome.subject_test_response
                  WHERE subject_test_response.subject_test_name::text = 'Disease Response'::text AND subject_test_response.subject_test_category::text = 'Evaluation of Response (IMWG Criteria)'::text AND (subject_test_response.subject_test_value::text = 'CR'::text OR subject_test_response.subject_test_value::text = 'sCR'::text)) str
      LEFT JOIN ( SELECT visit.subject_id, visit.visit_date_actl
                   FROM orbit_64407564mmy3009.visit
                  WHERE visit.visit_oid::text = 'C1D1'::text) v ON str.subject_id::text = v.subject_id::text
  CROSS JOIN ( SELECT biomarker_schedule.visit_oid
              FROM orbit_64407564mmy3009.biomarker_schedule
             WHERE biomarker_schedule.visit_oid::text ~~ '%CR+%'::text) fuv) derived_table42) v ON ss.subject_id::text = v.subject_id::text AND bps.visit_oid::text = v.visit_match::text
   LEFT JOIN ( SELECT DISTINCT specimen.subject_id, specimen.visit_id, specimen.specimen_collection_date
   FROM orbit_64407564mmy3009.specimen) sv ON upper(bps.specimen_visit_id::text) = upper(sv.visit_id::text) AND v.subject_id::text = sv.subject_id::text
  WHERE 
CASE
    WHEN (ss.study_subject_status::text = 'Screening'::text OR ss.study_subject_status::text = 'Screen Failed'::text) AND bps.visit_oid::text <> 'SCREEN'::text THEN 'remove'::text
    WHEN COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) IS NOT NULL AND COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) >= bps.protocol_start_date AND (COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) <= bps.protocol_end_date OR bps.protocol_end_date IS NULL) THEN 'keep'::text
    WHEN COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) IS NULL AND v.visit_date_exp >= bps.protocol_start_date AND (v.visit_date_exp <= bps.protocol_end_date OR bps.protocol_end_date IS NULL) THEN 'keep'::text
    WHEN COALESCE(v.visit_date_actl::timestamp without time zone, sp.specimen_collection_date, sv.specimen_collection_date) IS NULL AND v.visit_date_exp IS NULL AND bps.protocol_end_date IS NULL THEN 'keep'::text
    ELSE 'remove'::text
END = 'keep'::text AND ss.study_subject_status::text <> 'Inactive'::text AND ss.study_subject_status::text <> 'Relocated Subject'::text AND (ss.subject_id::text ~~ '%CN%'::text AND bps."region"::text = 'China'::text OR ss.subject_id::text !~~ '%CN%'::text AND bps."region"::text = 'Ex-China'::text)
UNION 
 SELECT DISTINCT ss.subject_id, ss.site_id, s.site_country_name, ss.date_screening, ss.date_screen_failure, ss.date_enrollment, ss.date_termination, ss.study_subject_status, ss.study_arm, ss.study_part, NULL::text AS cohort, NULL::date AS visit_date_exp, NULL::text AS visit_window_days, NULL::date AS exp_visit_window_min, NULL::date AS exp_visit_window_max, NULL::date AS visit_date_actl, 'UNSHEDULED'::text AS v_visit_oid, sp.visit_id AS sp_visit_id, sp.specimen_collection_date, NULL::text AS "region", sp.vendor_id::character varying AS vendor_id, vd.vendor_name, 'UNSCHEDULED'::text AS exp_visit, 'UNSCHEDULED'::text AS exp_visit_name, NULL::text AS exp_arm, NULL::text AS assessment_group, NULL::text AS assessment, regexp_replace(sp.specimen_class::text, ' -.*| / .*|/Extra.*'::text, ''::text)::character varying AS exp_specimen_type, NULL::text AS timepoint, sp.vendor_specimen_type AS exp_specimen_class, sp.visit_id AS specimen_visit_id, NULL::text AS scheduled_collection, sp.specimen_class, sp.specimen_type, sp.accession_number, sp.specimen_id, sp.specimen_received_date, sp.specimen_accession_date, sp.specimen_status, sp.specimen_collection_date AS past_visit_date, 'Collected'::text AS collection_status, NULL::text AS protocol_version, NULL::date AS protocol_start_date, NULL::date AS protocol_end_date, 'keep'::text AS on_protocol, NULL::text AS collection_comment
   FROM ( SELECT study_subject.study_id, study_subject.subject_id, study_subject.site_id, study_subject.date_screening, study_subject.date_screen_failure, study_subject.date_enrollment, study_subject.date_termination, study_subject.study_subject_status, study_subject.study_arm, study_subject.study_part
           FROM orbit_64407564mmy3009.study_subject) ss
   LEFT JOIN ( SELECT specimen.subject_id, specimen.visit_id, specimen.specimen_class, specimen.specimen_type, specimen.vendor_specimen_type, specimen.vendor_id, specimen.accession_number, specimen.specimen_id, specimen.specimen_collection_date, specimen.specimen_received_date, specimen.specimen_accession_date, specimen.specimen_status
           FROM orbit_64407564mmy3009.specimen) sp ON ss.subject_id::text = sp.subject_id::text
   LEFT JOIN orbit_64407564mmy3009.study_site sst ON ss.site_id::text = sst.site_id::text AND ss.study_id::text = sst.study_id::text
   LEFT JOIN orbit_64407564mmy3009.site s ON ss.site_id::text = s.site_id::text AND ss.study_id::text = s.study_id::text AND sst.site_country::text = s.site_country_code::text
   LEFT JOIN orbit_64407564mmy3009.vendor vd ON sp.vendor_id = vd.vendor_id
  WHERE (upper(sp.visit_id::text) = 'UNSCHEDULED'::text OR upper(sp.visit_id::text) = 'UNSCHEDULED|UNSCHEDULED'::text) AND (sp.vendor_specimen_type::text = 'CYTOF'::text OR sp.vendor_specimen_type::text = 'ARCHIVAL'::text OR sp.vendor_specimen_type::text = 'MRD'::text OR sp.vendor_specimen_type::text = 'CYTOF/Molecular Markers'::text OR sp.vendor_specimen_type::text = 'MM FISH'::text) OR upper(sp.visit_id::text) = 'UNSCH'::text AND (sp.vendor_specimen_type::text = 'SM12'::text OR sp.vendor_specimen_type::text = 'SM13'::text)
  ORDER BY 1, 19, 16, 12;
_______________________________________
-- orbit_64407564mmy3009.gene_exp_assay source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.gene_exp_assay
AS SELECT gene_exp_assay.vendor_id, gene_exp_assay.exp_assay_id, gene_exp_assay.exp_assay_type, gene_exp_assay.chipset, gene_exp_assay.chipset_type, gene_exp_assay.annotation_set, gene_exp_assay.norm_method, gene_exp_assay.file_type
   FROM orbit.gene_exp_assay
  WHERE (gene_exp_assay.exp_assay_id IN ( SELECT gene_exp_scores.exp_assay_id
           FROM orbit.gene_exp_scores
          WHERE gene_exp_scores.study_id::text = '64407564MMY3009'::text
          GROUP BY gene_exp_scores.exp_assay_id));
___________________________________________

-- orbit_64407564mmy3009.gene_exp_scores source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.gene_exp_scores
AS SELECT gene_exp_scores.exp_assay_id, gene_exp_scores.study_id, gene_exp_scores.subject_id, gene_exp_scores.features, gene_exp_scores.score
   FROM orbit.gene_exp_scores
  WHERE gene_exp_scores.study_id::text = '64407564MMY3009'::text;

_________________________________________

-- orbit_64407564mmy3009.gene_features source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.gene_features
AS SELECT gene_features.features, gene_features.ensembl_gene_id, gene_features.entrez_gene_id, gene_features.gene_biotype, gene_features.chr, gene_features.seqloc_start, gene_features.seqloc_end, gene_features.seqstrand
   FROM orbit.gene_features
  WHERE (gene_features.features IN ( SELECT gene_exp_scores.features
           FROM orbit.gene_exp_scores
          WHERE gene_exp_scores.study_id::text = '64407564MMY3009'::text
          GROUP BY gene_exp_scores.features));
__________________________________________
-- orbit_64407564mmy3009.gene_signatures source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.gene_signatures
AS SELECT gene_signatures.signature_name, gene_signatures.signature, gene_signatures.citation, gene_signatures.description, gene_signatures.inventor, gene_signatures.endpoint, gene_signatures.disease, gene_signatures."model_type", gene_signatures.institution, gene_signatures.create_date, gene_signatures.class_type
   FROM orbit.gene_signatures
  WHERE (gene_signatures.signature IN ( SELECT gene_signatures_cat.signature_name
           FROM orbit.gene_signatures_cat
          WHERE gene_signatures_cat.study_id::text = '64407564MMY3009'::text
          GROUP BY gene_signatures_cat.signature_name));
_____________________________________
-- orbit_64407564mmy3009.gene_signatures_cat source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.gene_signatures_cat
AS SELECT gene_signatures_cat.exp_assay_id, gene_signatures_cat.study_id, gene_signatures_cat.subject_id, gene_signatures_cat.signature_name, gene_signatures_cat.value
   FROM orbit.gene_signatures_cat
  WHERE gene_signatures_cat.study_id::text = '64407564MMY3009'::text;
_____________________________
-- orbit_64407564mmy3009.gene_signatures_scores source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.gene_signatures_scores
AS SELECT gene_signatures_scores.exp_assay_id, gene_signatures_scores.study_id, gene_signatures_scores.subject_id, gene_signatures_scores.signature_name, gene_signatures_scores.score
   FROM orbit.gene_signatures_scores
  WHERE gene_signatures_scores.study_id::text = '64407564MMY3009'::text;
_________________________________________________

-- orbit_64407564mmy3009.genes source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.genes
AS SELECT genes.gene_name, genes.gene_egid, genes.ref_seq, genes.chromosome, genes.run_id, genes.row_id
   FROM orbit.genes;
___________________________

-- orbit_64407564mmy3009.genomic_assay source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.genomic_assay
AS SELECT genomic_assay.genomic_assay_id, genomic_assay.vendor_id, genomic_assay.assay, genomic_assay.device_name, genomic_assay.platform, genomic_assay.assembly, genomic_assay.run_id, genomic_assay.row_id
   FROM orbit.genomic_assay;
______________________________
-- orbit_64407564mmy3009.genomic_variant_type source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.genomic_variant_type
AS SELECT genomic_variant_type.genvar_type_id, genomic_variant_type.genvar_type_name, genomic_variant_type.run_id
   FROM orbit.genomic_variant_type;
______________________

-- orbit_64407564mmy3009.igg_measurement_lookup source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.igg_measurement_lookup
AS SELECT ((((((((study_subject.study_id::text || '|'::text) || study_subject.study_id::text) || '|'::text) || study_subject.subject_id::text) || COALESCE(trunc(igg_mg_dl.specimen_collection_date)::character varying, ''::character varying)::text) || 
        CASE
            WHEN igg_mg_dl.specimen_collection_date IS NOT NULL THEN '|'::text
            ELSE ''::text
        END) || COALESCE(igg_mg_dl.test_result_std_value, ''::character varying)::text) || 
        CASE
            WHEN igg_mg_dl.test_result_std_value IS NOT NULL THEN '|'::text
            ELSE ''::text
        END) || COALESCE(igg_mg_dl.visit_id, ''::character varying)::text AS unique_key, study_subject.study_id, study_subject.subject_id, study_subject.site_id, igg_mg_dl.specimen_collection_date AS igg_collection_date, igg_mg_dl.test_result_std_value_char AS igg_mg_dl, igg_mg_dl.visit_id
   FROM orbit_64407564mmy3009.study_subject study_subject
   LEFT JOIN ( SELECT DISTINCT specimen.subject_id, specimen.study_id, specimen.specimen_id, specimen.accession_number, specimen.specimen_collection_date, specimen.visit_id, specimen_test.test_result_std_value, 
                CASE
                    WHEN regexp_instr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) > 0 THEN regexp_replace(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text)::double precision * 100::double precision
                    ELSE specimen_test.test_result_std_value::double precision * 100::double precision
                END AS test_result_std_value_numeric_mg, 
                CASE
                    WHEN 
                    CASE
                        WHEN regexp_instr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) > 0 THEN regexp_replace(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text)::double precision * 100::double precision
                        ELSE specimen_test.test_result_std_value::double precision * 100::double precision
                    END > spep.spep_mg_dl::double precision THEN 
                    CASE
                        WHEN regexp_instr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) > 0 THEN regexp_replace(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text)::double precision * 100::double precision
                        ELSE specimen_test.test_result_std_value::double precision * 100::double precision
                    END - COALESCE(spep.spep_mg_dl, 0::numeric)::double precision
                    ELSE 
                    CASE
                        WHEN regexp_instr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) > 0 THEN regexp_replace(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text)::double precision * 100::double precision
                        ELSE specimen_test.test_result_std_value::double precision * 100::double precision
                    END
                END AS calculated_igg_value, 
                CASE
                    WHEN regexp_instr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) > 0 THEN (regexp_substr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) || round(
                    CASE
                        WHEN 
                        CASE
                            WHEN regexp_instr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) > 0 THEN regexp_replace(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text)::double precision * 100::double precision
                            ELSE specimen_test.test_result_std_value::double precision * 100::double precision
                        END > spep.spep_mg_dl::double precision THEN 
                        CASE
                            WHEN regexp_instr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) > 0 THEN regexp_replace(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text)::double precision * 100::double precision
                            ELSE specimen_test.test_result_std_value::double precision * 100::double precision
                        END - COALESCE(spep.spep_mg_dl, 0::numeric)::double precision
                        ELSE 
                        CASE
                            WHEN regexp_instr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) > 0 THEN regexp_replace(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text)::double precision * 100::double precision
                            ELSE specimen_test.test_result_std_value::double precision * 100::double precision
                        END
                    END, 2::numeric)::character varying(255)::text)::character varying
                    ELSE 
                    CASE
                        WHEN 
                        CASE
                            WHEN regexp_instr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) > 0 THEN regexp_replace(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text)::double precision * 100::double precision
                            ELSE specimen_test.test_result_std_value::double precision * 100::double precision
                        END > spep.spep_mg_dl::double precision THEN 
                        CASE
                            WHEN regexp_instr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) > 0 THEN regexp_replace(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text)::double precision * 100::double precision
                            ELSE specimen_test.test_result_std_value::double precision * 100::double precision
                        END - COALESCE(spep.spep_mg_dl, 0::numeric)::double precision
                        ELSE 
                        CASE
                            WHEN regexp_instr(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text) > 0 THEN regexp_replace(specimen_test.test_result_std_value::text, '[^[:digit:].]'::text)::double precision * 100::double precision
                            ELSE specimen_test.test_result_std_value::double precision * 100::double precision
                        END
                    END::character varying(255)
                END AS test_result_std_value_char, 
                CASE
                    WHEN spep.spep_mg_dl IS NULL OR spep.spep_mg_dl = 0::numeric THEN 0
                    ELSE 1
                END AS igg_calculation_flag
           FROM orbit_64407564mmy3009.specimen specimen
      LEFT JOIN orbit_64407564mmy3009.specimen_test specimen_test ON specimen.specimen_id::text = specimen_test.specimen_id::text
   LEFT JOIN ( SELECT DISTINCT spep_kappa_lambda.subject_id, spep_kappa_lambda.study_id, spep_kappa_lambda.accession_number, spep_kappa_lambda.specimen_collection_date, specimen_test.test_name, specimen_test.test_result_orig_value_numeric::numeric * 100::numeric AS spep_mg_dl
              FROM ( SELECT specimen.subject_id, specimen.study_id, specimen.specimen_id, specimen.accession_number, specimen.specimen_collection_date, specimen_test.test_name, specimen_test.test_result_orig_value_numeric
                      FROM orbit_64407564mmy3009.specimen
                 LEFT JOIN orbit_64407564mmy3009.specimen_test ON specimen.specimen_id::text = specimen_test.specimen_id::text
                WHERE specimen_test.test_name::text = 'MyeloSPE Immunofix.Impress1-CL'::text AND specimen_test.test_result_orig_value::text ~~ 'IgG%'::text) spep_kappa_lambda
         JOIN orbit_64407564mmy3009.specimen specimen ON spep_kappa_lambda.subject_id::text = specimen.subject_id::text AND spep_kappa_lambda.accession_number::text = specimen.accession_number::text AND trunc(spep_kappa_lambda.specimen_collection_date) = trunc(specimen.specimen_collection_date)
    JOIN orbit_64407564mmy3009.specimen_test ON spep_kappa_lambda.specimen_id::text = specimen_test.specimen_id::text
   WHERE specimen_test.test_name::text = 'Total M-Protein, Serum-CL-QT'::text) spep ON specimen.subject_id::text = spep.subject_id::text AND specimen.accession_number::text = spep.accession_number::text AND specimen.specimen_collection_date = spep.specimen_collection_date
  WHERE specimen.vendor_id = 3 AND specimen_test.test_category::text ~~ 'IMMUNOGLOBULIN%'::text AND specimen_test.test_name::text ~~ 'Immunoglobulin G%'::text) igg_mg_dl ON study_subject.subject_id::text = igg_mg_dl.subject_id::text;
________________________________
-- orbit_64407564mmy3009.indication_alias source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.indication_alias
AS SELECT indication_alias.indication, indication_alias.indication_alias, indication_alias.run_id
   FROM orbit.indication_alias;

_______________________________
-- orbit_64407564mmy3009.mrd_tracking_vw source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.mrd_tracking_vw
AS SELECT DISTINCT ss.study_id, ss.site_id, ss.study_subject_status, ss.study_arm, COALESCE(s.subject_id, ss.subject_id) AS subject_id, os.site_country_name, s.specimen_id, t1.accession_number, s.visit_id, s.visit_id_cut, s.specimen_collection_date, t1.specimen_class, s.specimen_type, s.vendor_specimen_type, "replace"(ci."clone id status", 'NO ID CLONE'::text, 'NO CLONE IDENTIFIED'::text) AS "clone id status", ci.basline_flag AS "baseline sample", mrd.test_result_orig_value_string AS "mrd status", mrd.test_result_orig_unit AS "mrd threshold", rave.test_result_orig_value AS rave_plasma_cell_percent, rave.rave_specimen_test_id, rave.rave_specimen_id, dna.test_result_orig_value AS dna_input
   FROM ( SELECT study_subject.study_id, study_subject.subject_id, study_subject.site_id, study_subject.study_arm, study_subject.study_subject_status
           FROM orbit_64407564mmy3009.study_subject) ss
   LEFT JOIN ( SELECT sa.specimen_id, sa.accession_number, sa.specimen_collection_date, s.specimen_class, s.specimen_type, s.vendor_specimen_type, s.visit_id, vis.visit_name, s.subject_id, split_part(s.visit_id::text, '|'::text, 2) AS visit_id_cut
           FROM ( SELECT specimen.specimen_id, specimen.accession_number, specimen.study_subject, specimen.study_id, specimen.subject_id, specimen.pre_screening_id, specimen.visit_id, specimen.vendor_id, specimen.specimen_class, specimen.specimen_type, specimen.storage_location, specimen.storage_state, specimen.storage_temperature, specimen.vendor_specimen_id, specimen.vendor_subject_id, specimen.vendor_study_id, specimen.site_specimen_id, specimen.specimen_condition, specimen.specimen_extract_location, specimen.specimen_collection_date, specimen.specimen_received_date, specimen.vendor_specimen_type, specimen.specimen_status, specimen.specimen_accession_date, specimen.specimen_reporting_date, specimen.repeat_status, specimen.repeat_times, specimen.number_of_slides, specimen.number_of_slides_needed, specimen.reason_qualified_or_failed, specimen.sample_pass_fail_status, specimen.run_id, specimen.composite_primary_key, specimen.row_id, "substring"(specimen.subject_id::text, 4) AS trimmed_subject_id
                   FROM orbit_64407564mmy3009.specimen
                  WHERE specimen.vendor_id = 29) sa
      LEFT JOIN orbit.specimen s ON s.specimen_id::text = sa.specimen_id::text AND s.study_id::text = sa.study_id::text
   LEFT JOIN orbit_64407564mmy3009.visit vis ON vis.subject_id::text = sa.trimmed_subject_id AND vis.visit_date_actl::text = "left"(s.specimen_collection_date::text, 10)
  WHERE s.specimen_class::text ~~ '%MRD%'::text OR s.specimen_class::text ~~ '%ARCHIVAL%'::text) s ON ss.subject_id::text = s.subject_id::text
   LEFT JOIN ( SELECT s.accession_number, st.specimen_id, 
           CASE
               WHEN st.test_status IS NULL OR st.test_status::text = '|'::text THEN 'Complete'::text
               ELSE "replace"(st.test_status::text, 'NOT DONE|'::text, ''::text)
           END AS "clone id status", st.basline_flag
      FROM ( SELECT specimen_test.specimen_test_id, specimen_test.specimen_id, specimen_test.study_id, specimen_test.vendor_id, specimen_test.vendor_specimen_id, specimen_test.test_code, specimen_test.test_name, specimen_test.test_category, specimen_test.test_result_orig_value, specimen_test.test_result_orig_value_string, specimen_test.test_result_orig_value_numeric, specimen_test.test_result_orig_value_datetime, specimen_test.test_result_orig_value_cancelled, specimen_test.test_result_orig_unit, specimen_test.test_result_std_value, specimen_test.test_result_std_unit, specimen_test.test_status, specimen_test.basline_flag, specimen_test.test_start_date_time, specimen_test.test_end_date_time, specimen_test.test_category_code, specimen_test.test_result_date, specimen_test.test_filed_date, specimen_test.test_review_date, specimen_test.reason_test_qualified_or_failed, specimen_test."comment", specimen_test.labcorp_sequence_num, specimen_test.run_id, specimen_test.composite_primary_key, specimen_test.row_id
              FROM orbit_64407564mmy3009.specimen_test
             WHERE specimen_test.vendor_id = 29) st
   LEFT JOIN orbit_64407564mmy3009.specimen s ON st.specimen_id::text = s.specimen_id::text
  WHERE st.test_name::text = 'Clone Frequency'::text) ci ON s.specimen_id::text = ci.specimen_id::text
   LEFT JOIN ( SELECT s.accession_number, st.test_result_orig_value_string, st.test_result_orig_unit
   FROM ( SELECT specimen_test.specimen_test_id, specimen_test.specimen_id, specimen_test.study_id, specimen_test.vendor_id, specimen_test.vendor_specimen_id, specimen_test.test_code, specimen_test.test_name, specimen_test.test_category, specimen_test.test_result_orig_value, specimen_test.test_result_orig_value_string, specimen_test.test_result_orig_value_numeric, specimen_test.test_result_orig_value_datetime, specimen_test.test_result_orig_value_cancelled, specimen_test.test_result_orig_unit, specimen_test.test_result_std_value, specimen_test.test_result_std_unit, specimen_test.test_status, specimen_test.basline_flag, specimen_test.test_start_date_time, specimen_test.test_end_date_time, specimen_test.test_category_code, specimen_test.test_result_date, specimen_test.test_filed_date, specimen_test.test_review_date, specimen_test.reason_test_qualified_or_failed, specimen_test."comment", specimen_test.labcorp_sequence_num, specimen_test.run_id, specimen_test.composite_primary_key, specimen_test.row_id
           FROM orbit_64407564mmy3009.specimen_test
          WHERE specimen_test.vendor_id = 29) st
   LEFT JOIN orbit_64407564mmy3009.specimen s ON st.specimen_id::text = s.specimen_id::text) mrd ON s.accession_number::text = mrd.accession_number::text
   LEFT JOIN ( SELECT s.accession_number, s.concat_id, pc.test_result_orig_value, pc.rave_specimen_test_id, pc.rave_specimen_id
   FROM ( SELECT split_part(derived_table44.specimen_id::text, '|'::text, 2) AS subject_id, split_part(derived_table44.specimen_id::text, '|'::text, 4) AS visit, split_part(derived_table44.specimen_id::text, '|'::text, 5) AS specimen_type, 
                CASE
                    WHEN split_part(derived_table44.specimen_id::text, '|'::text, 4) = 'Screening'::text OR split_part(derived_table44.specimen_id::text, '|'::text, 4) = 'Baseline Disease Evaluation'::text THEN concat(derived_table44.study_id::text, concat('|'::text, concat(split_part(derived_table44.specimen_id::text, '|'::text, 2), concat('|'::text, concat('SCREENING'::text, concat('|'::text, upper(split_part(derived_table44.specimen_id::text, '|'::text, 5))))))))
                    ELSE concat(derived_table44.study_id::text, concat('|'::text, concat(split_part(derived_table44.specimen_id::text, '|'::text, 2), concat('|'::text, concat(split_part(derived_table44.specimen_id::text, '|'::text, 4), concat('|'::text, upper(split_part(derived_table44.specimen_id::text, '|'::text, 5))))))))
                END AS concat_id, derived_table44.test_result_orig_value, derived_table44.specimen_test_id AS rave_specimen_test_id, derived_table44.specimen_id AS rave_specimen_id
           FROM ( SELECT specimen_test.specimen_test_id, specimen_test.specimen_id, specimen_test.study_id, specimen_test.vendor_id, specimen_test.vendor_specimen_id, specimen_test.test_code, specimen_test.test_name, specimen_test.test_category, specimen_test.test_result_orig_value, specimen_test.test_result_orig_value_string, specimen_test.test_result_orig_value_numeric, specimen_test.test_result_orig_value_datetime, specimen_test.test_result_orig_value_cancelled, specimen_test.test_result_orig_unit, specimen_test.test_result_std_value, specimen_test.test_result_std_unit, specimen_test.test_status, specimen_test.basline_flag, specimen_test.test_start_date_time, specimen_test.test_end_date_time, specimen_test.test_category_code, specimen_test.test_result_date, specimen_test.test_filed_date, specimen_test.test_review_date, specimen_test.reason_test_qualified_or_failed, specimen_test."comment", specimen_test.labcorp_sequence_num, specimen_test.run_id, specimen_test.composite_primary_key, specimen_test.row_id
                   FROM orbit_64407564mmy3009.specimen_test
                  WHERE specimen_test.vendor_id = 6 AND specimen_test.test_name::text = 'Plasma Cells'::text) derived_table44) pc
   JOIN ( SELECT sa.accession_number, 
                CASE
                    WHEN sa.visit_id::text = 'SCRBMA'::text THEN concat(sa.study_id::text, concat('|'::text, concat(sa.subject_id::text, concat('|'::text, concat('SCREENING'::text, concat('|'::text, upper(split_part(s.specimen_type::text, ','::text, 1))))))))
                    ELSE concat(sa.study_id::text, concat('|'::text, concat(sa.subject_id::text, concat('|'::text, concat(vis.visit_name::text, concat('|'::text, upper(split_part(s.specimen_type::text, ','::text, 1))))))))
                END AS concat_id
           FROM ( SELECT specimen.specimen_id, specimen.accession_number, specimen.study_subject, specimen.study_id, specimen.subject_id, specimen.pre_screening_id, specimen.visit_id, specimen.vendor_id, specimen.specimen_class, specimen.specimen_type, specimen.storage_location, specimen.storage_state, specimen.storage_temperature, specimen.vendor_specimen_id, specimen.vendor_subject_id, specimen.vendor_study_id, specimen.site_specimen_id, specimen.specimen_condition, specimen.specimen_extract_location, specimen.specimen_collection_date, specimen.specimen_received_date, specimen.vendor_specimen_type, specimen.specimen_status, specimen.specimen_accession_date, specimen.specimen_reporting_date, specimen.repeat_status, specimen.repeat_times, specimen.number_of_slides, specimen.number_of_slides_needed, specimen.reason_qualified_or_failed, specimen.sample_pass_fail_status, specimen.run_id, specimen.composite_primary_key, specimen.row_id
                   FROM orbit_64407564mmy3009.specimen
                  WHERE specimen.vendor_id = 29) sa
      LEFT JOIN orbit.specimen s ON s.accession_number::text = sa.accession_number::text AND s.study_id::text = sa.study_id::text
   LEFT JOIN orbit_64407564mmy3009.visit vis ON vis.subject_id::text = sa.subject_id::text AND vis.visit_date_actl::text = "left"(s.specimen_collection_date::text, 10)
  WHERE s.specimen_class::text ~~ '%MRD%'::text OR s.specimen_class::text ~~ '%ARCHIVAL%'::text) s ON pc.concat_id = s.concat_id) rave ON rave.accession_number::text = s.accession_number::text
   LEFT JOIN ( SELECT a.specimen_id, a.test_name, a.test_result_orig_value
   FROM ( SELECT specimen_test.specimen_test_id, specimen_test.specimen_id, specimen_test.study_id, specimen_test.vendor_id, specimen_test.vendor_specimen_id, specimen_test.test_code, specimen_test.test_name, specimen_test.test_category, specimen_test.test_result_orig_value, specimen_test.test_result_orig_value_string, specimen_test.test_result_orig_value_numeric, specimen_test.test_result_orig_value_datetime, specimen_test.test_result_orig_value_cancelled, specimen_test.test_result_orig_unit, specimen_test.test_result_std_value, specimen_test.test_result_std_unit, specimen_test.test_status, specimen_test.basline_flag, specimen_test.test_start_date_time, specimen_test.test_end_date_time, specimen_test.test_category_code, specimen_test.test_result_date, specimen_test.test_filed_date, specimen_test.test_review_date, specimen_test.reason_test_qualified_or_failed, specimen_test."comment", specimen_test.labcorp_sequence_num, specimen_test.run_id, specimen_test.composite_primary_key, specimen_test.row_id
           FROM orbit_64407564mmy3009.specimen_test
          WHERE specimen_test.test_name::text = 'sample_amount_ng'::text) a
   LEFT JOIN orbit_64407564mmy3009.specimen s ON s.specimen_id::text = a.specimen_id::text) dna ON dna.specimen_id::text = s.specimen_id::text
   LEFT JOIN orbit_64407564mmy3009.study_site sst ON ss.site_id::text = sst.site_id::text AND ss.study_id::text = sst.study_id::text
   LEFT JOIN orbit_64407564mmy3009.site os ON ss.site_id::text = os.site_id::text AND ss.study_id::text = os.study_id::text AND sst.site_country::text = os.site_country_code::text
   LEFT JOIN ( SELECT specimen.specimen_id, "max"(specimen.accession_number::text) AS accession_number, "max"(specimen.specimen_class::text) AS specimen_class
   FROM orbit_64407564mmy3009.specimen
  WHERE specimen.vendor_id = 21 OR specimen.vendor_id = 29
  GROUP BY specimen.specimen_id) t1 ON t1.specimen_id::text = s.specimen_id::text
  ORDER BY ss.site_id, ss.subject_id, s.accession_number;
_______________________________
-- orbit_64407564mmy3009.q2_flow_cytometry_vw source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.q2_flow_cytometry_vw
AS SELECT DISTINCT ss.study_id, ss.subject_id, ss.site_id, "left"(split_part(ss.site_id::text, '-'::text, 2), 2) AS country_code, ss.date_screening, ss.date_enrollment, ss.cohort, ss.study_arm, ss.study_subject_status, am."domain", am.vendor_id, "right"(am.subject_id::text, 6) AS subject_id_q2, am.specimen_id, am.vendor_specimen_id, s.accession_number, s.visit_id, v.report_value AS critical_visit, am.analyte_panel, ap."assay panel", am.status, 
        CASE
            WHEN am."domain"::text = 'LB'::text AND am.status IS NULL THEN 'D'::character varying
            WHEN am."domain"::text = 'LB'::text AND am.status::text = 'NOT DONE'::text THEN 'X'::character varying
            WHEN am."domain"::text = 'vendor_file'::text THEN am.status
            ELSE NULL::character varying
        END AS test_status, am.measurement_name, am.measurement_value, am.measurement_value_unit, am."comment", am.original_source_reportable, am.original_source_reportable_code
   FROM orbit_64407564mmy3009.study_subject ss
   LEFT JOIN orbit_64407564mmy3009.analyte_measurement am ON am.subject_id::text = ss.subject_id::text
   LEFT JOIN ( SELECT DISTINCT am.analyte_panel, "left"(am.analyte_panel::text, 4) AS assay_panel_num, 
           CASE
               WHEN am.analyte_panel::text ~~ '%BMA%'::text OR am.analyte_panel::text ~~ '%Bone Marrow%'::text OR am.analyte_panel::text ~~ '%A820%'::text THEN 'BMA'::text
               ELSE 'BLOOD'::text
           END AS assay_panel_str, "left"(am.analyte_panel::text, 4) + ' '::text + 
           CASE
               WHEN am.analyte_panel::text ~~ '%BMA%'::text OR am.analyte_panel::text ~~ '%Bone Marrow%'::text OR am.analyte_panel::text ~~ '%A820%'::text THEN 'BMA'::text
               ELSE 'BLOOD'::text
           END AS "assay panel"
      FROM orbit_64407564mmy3009.analyte_measurement am) ap ON ap.analyte_panel::text = am.analyte_panel::text
   LEFT JOIN ( SELECT DISTINCT specimen.visit_id, specimen.vendor_specimen_id, specimen.accession_number
   FROM orbit_64407564mmy3009.specimen
  WHERE specimen.vendor_id = 28) s ON s.vendor_specimen_id::text = am.vendor_specimen_id::text
   LEFT JOIN ( SELECT q2_critical_visits.study_id, q2_critical_visits.value_type, q2_critical_visits.value, q2_critical_visits.report_value_type, q2_critical_visits.report_value
   FROM orbit_64407564mmy3009.q2_critical_visits) v ON v.value::text = s.visit_id::text AND v.study_id::text = ss.study_id::text;
_______________________________________
-- orbit_64407564mmy3009.row_source_data_study_vw source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.row_source_data_study_vw
AS SELECT dm.table_name, 
        CASE
            WHEN dm.dataset_name::text = ANY (ARRAY['iaware_orbit_site'::text, 'iaware_orbit_study'::text, 'iaware_orbit_study_site'::text, 'iaware_orbit_study_subject'::text, 'iaware_orbit_visit'::text, 'covance_protocol'::text, 'covance_investigator'::text, 'covance_patient'::text, 'covance_group'::text, 'covance_lab_test'::text, 'covance_lab_result'::text, 'covance_container'::text, 'fmi_query_log'::text, 'fmi_psst'::text, 'fmi_oapl'::text, 'fmi_ospl'::text, 'fmi_biomarker_mapping'::text, 'fmi_lsst'::text, 'invitae_looker'::text, 'cell_carta_sample_inventory'::text, 'cell_carta_image_assay_results'::text, 'iwrs_subject_summary'::text, 'edcom_visit'::text]) THEN 'Legacy Dataset - Stitched'::character varying
            WHEN dm.dataset_name::text = ANY (ARRAY['analyte'::text, 'analyte_characterization'::text, 'genes'::text, 'genomic_assay'::text, 'site'::text, 'specimen_genomic_assay'::text, 'analyte_measurement'::text, 'genomic_variant'::text, 'specimen'::text, 'specimen_event'::text, 'specimen_biomarker_pgx_finding'::text, 'specimen_pgx_finding'::text, 'specimen_test'::text, 'study'::text, 'study_site'::text, 'study_subject'::text, 'study_subject_consent'::text, 'study_subject_history'::text, 'subject_drug_treatment'::text, 'subject_test'::text, 'subject_test_response'::text, 'visit'::text, 'specimen_lineage'::text, 'vendor'::text, 'vendor_assay_genomic'::text, 'genomic_variant_type'::text]) THEN 'ORBIT Redshift'::character varying
            ELSE meta.dataset_type
        END AS dataset_type, dm.row_id, dm.study_id, dm.primary_key, dm.dataset_name, meta.file_name, meta.s3_source_location, meta.source_modified_time AS latest_modified_time
   FROM ( SELECT st.table_name, st.row_id, st.study_id, st.primary_key, COALESCE(info.dataset_name, st.dataset_info) AS dataset_name
           FROM orbit_64407564mmy3009.row_source_data_study st
      LEFT JOIN orbit.dataset_batch_id_mapping_info info ON btrim(lower(st.dataset_info::text)) = btrim(lower(info.batch_id::text))) dm
   LEFT JOIN ( SELECT source_data_metadata.dataset_type, source_data_metadata.dataset_name, source_data_metadata.file_name, source_data_metadata.s3_source_location, source_data_metadata.source_modified_time, source_data_metadata.study_id, source_data_metadata.table_type
           FROM orbit.source_data_metadata
          WHERE source_data_metadata.study_id::text = '64407564MMY3009'::text OR source_data_metadata.study_id::text = ''::text) meta ON btrim(lower(dm.dataset_name::text)) = btrim(lower(meta.dataset_name::text));
_________________________________
-- orbit_64407564mmy3009.sample_inventory_vw source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.sample_inventory_vw
AS SELECT DISTINCT COALESCE("right"(ss.subject_id::text, 11), "right"(sp.subject_id::text, 11)) AS subject_id, ss.study_id, ss.study_arm, ss.cohort, ss.study_subject_status, ss.date_enrollment, ss.date_termination, ss.date_treat_termination, ss.date_screening, ss.date_screen_failure, s.site_id, s.site_name, s.site_country_name, s.site_country_code, sp.accession_number, sp.visit_id, v.vendor_id, v.vendor_name, sp.specimen_class, sp.specimen_type, sp.storage_location, sp.storage_state, sp.vendor_specimen_id, sp.specimen_condition, sp.specimen_collection_date, sp.specimen_received_date, date_diff('day'::text, sp.specimen_collection_date, sp.specimen_received_date) - date_diff('week'::text, sp.specimen_collection_date, sp.specimen_received_date) * 2 - 
        CASE
            WHEN pgdate_part('dow'::text, sp.specimen_collection_date) = 0::double precision THEN 1
            ELSE 0
        END - 
        CASE
            WHEN pgdate_part('dow'::text, sp.specimen_received_date) = 6::double precision THEN 1
            ELSE 0
        END AS bd_collect_received, sp.vendor_specimen_type, sp.specimen_status, sp.specimen_accession_date, sp.number_of_slides, sp.specimen_id, a.soa, a.sm_code
   FROM orbit_64407564mmy3009.study_subject ss
   FULL JOIN ( SELECT specimen.specimen_id, specimen.accession_number, specimen.study_subject, specimen.study_id, specimen.subject_id, specimen.pre_screening_id, specimen.visit_id, specimen.vendor_id, specimen.specimen_class, specimen.specimen_type, specimen.storage_location, specimen.storage_state, specimen.storage_temperature, specimen.vendor_specimen_id, specimen.vendor_subject_id, specimen.vendor_study_id, specimen.site_specimen_id, specimen.specimen_condition, specimen.specimen_extract_location, specimen.specimen_collection_date, specimen.specimen_received_date, specimen.vendor_specimen_type, specimen.specimen_status, specimen.specimen_accession_date, specimen.specimen_reporting_date, specimen.repeat_status, specimen.repeat_times, specimen.number_of_slides, specimen.number_of_slides_needed, specimen.reason_qualified_or_failed, specimen.sample_pass_fail_status, specimen.run_id, specimen.composite_primary_key, specimen.row_id
           FROM orbit_64407564mmy3009.specimen) sp ON "right"(ss.subject_id::text, 11) = "right"(sp.subject_id::text, 11)
   JOIN ( SELECT DISTINCT c.vendor, sp.vendor_specimen_type, 
           CASE
               WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'SM%'::text THEN "substring"(sp.vendor_specimen_type::text, 1, 4)
               WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'HM%'::text THEN "substring"(sp.vendor_specimen_type::text, 1, 4)
               WHEN sp.vendor_id = 3 AND sp.specimen_class::text ~~ 'TBO%'::text THEN "substring"(sp.specimen_class::text, 1, 6)
               WHEN sp.vendor_id = 21 THEN sp.specimen_class::text
               ELSE NULL::text
           END AS sm_code, 
           CASE
               WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'SM%'::text THEN COALESCE(c.report_value, "substring"(sp.vendor_specimen_type::text, 1, 4)::character varying)
               WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'HM%'::text THEN COALESCE(c.report_value, "substring"(sp.vendor_specimen_type::text, 1, 4)::character varying)
               WHEN sp.vendor_id = 3 AND sp.specimen_class::text ~~ 'TBO%'::text THEN COALESCE(c.report_value, "substring"(sp.specimen_class::text, 1, 6)::character varying)
               WHEN sp.vendor_id = 21 THEN initcap(sp.specimen_type::text)::character varying
               ELSE NULL::character varying
           END AS soa
      FROM orbit_64407564mmy3009.specimen sp
   JOIN ( SELECT codes_of_interest.study_id, codes_of_interest.value_type, codes_of_interest.value, codes_of_interest.vendor, codes_of_interest.report_value_type, codes_of_interest.report_value
              FROM orbit_64407564mmy3009.codes_of_interest
             WHERE codes_of_interest.value_type::text = 'sm_code'::text) c ON "substring"(sp.vendor_specimen_type::text, 1, 4) = 
      CASE
          WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'SM%'::text THEN c.value
          WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'HM%'::text THEN c.value
          ELSE NULL::character varying
      END::text OR "substring"(sp.specimen_class::text, 1, 6) = 
      CASE
          WHEN sp.vendor_id = 3 AND sp.specimen_class::text ~~ 'TBO%'::text THEN c.value
          ELSE NULL::character varying
      END::text OR sp.vendor_id::text = 
      CASE
          WHEN sp.vendor_id = 21 THEN c.vendor
          ELSE NULL::character varying
      END::text) a ON sp.vendor_specimen_type::text = 
CASE
  WHEN sp.vendor_id = 3 THEN a.vendor_specimen_type
  ELSE NULL::character varying
END::text OR sp.vendor_id::text = a.vendor::text AND sp.specimen_class::text = a.sm_code OR sp.specimen_type::text = 
CASE
    WHEN sp.vendor_id = 21 AND sp.specimen_class IS NULL THEN upper(a.soa::text)
    ELSE NULL::text
END
   LEFT JOIN orbit_64407564mmy3009.study_site sst ON ss.site_id::text = sst.site_id::text AND ss.study_id::text = sst.study_id::text
   LEFT JOIN orbit_64407564mmy3009.site s ON ss.site_id::text = s.site_id::text AND ss.study_id::text = s.study_id::text AND sst.site_country::text = s.site_country_code::text
   LEFT JOIN orbit_64407564mmy3009.vendor v ON sp.vendor_id = v.vendor_id;
____________________________________
-- orbit_64407564mmy3009.sample_management_tool_gd_vw source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.sample_management_tool_gd_vw
AS SELECT asv.ta, asv.protocol_id, 'LabCorp' AS vendor, 'Biologics' AS sample_category, asv.subject_id, asv.subject_status, asv.study_arm, asv.country, asv.site_name, asv.pi_name, asv.cohort, asv.labcorp_pvc, asv.visit_name, asv.label_line_1, asv.sm_description, asv.accession_number, asv.container_number, asv.receipt_temperature, asv.shipping_datetime, asv.shipping_destination, COALESCE(asv."sample_type", rt."sample_type"::character varying) AS "sample_type", asv.collection_datetime, asv.actual_visit_date, asv.latest_modified_time, asv.site_id, asv.aliquot, 
        CASE
            WHEN asv.sm_code::text ~~ '%SM13%'::text OR asv.labcorp_pvc::text = 'BMAMRDSLID'::text THEN 'N'::character varying
            ELSE asv.not_mapped
        END AS not_mapped, 
        CASE
            WHEN asv.visit_oid::text = 'C1D1'::text THEN rand.visit_date_actl
            ELSE date(lsv.actual_visit_date + (acl.cycle_length * (asv."cycle" - lsv."cycle") + asv."day" - lsv."day" - asv.visit_window)::double precision * '1 day'::interval)
        END AS expected_visit_min, 
        CASE
            WHEN asv.visit_oid::text = 'C1D1'::text THEN date(rand.visit_date_actl + 7::double precision * '1 day'::interval)
            ELSE date(lsv.actual_visit_date + (acl.cycle_length * (asv."cycle" - lsv."cycle") + asv."day" - lsv."day" + asv.visit_window)::double precision * '1 day'::interval)
        END AS expected_visit_max, (
        CASE
            WHEN asv.visit_oid::text = 'C1D1'::text THEN rand.visit_date_actl
            ELSE date(lsv.actual_visit_date + (acl.cycle_length * (asv."cycle" - lsv."cycle") + asv."day" - lsv."day" - asv.visit_window)::double precision * '1 day'::interval)
        END::text || ' to '::text) || 
        CASE
            WHEN asv.visit_oid::text = 'C1D1'::text THEN date(rand.visit_date_actl + 7::double precision * '1 day'::interval)
            ELSE date(lsv.actual_visit_date + (acl.cycle_length * (asv."cycle" - lsv."cycle") + asv."day" - lsv."day" + asv.visit_window)::double precision * '1 day'::interval)
        END::text AS expected_visit_window, 
        CASE
            WHEN asv.actual_visit_date IS NOT NULL THEN 'Y'::text
            ELSE 'N'::text
        END AS data_status_edc_rave, 
        CASE
            WHEN asv.specimen_id IS NOT NULL THEN 'Y'::text
            ELSE 'N'::text
        END AS data_status_labcorp, 
        CASE
            WHEN lsv.actual_visit_date < 
            CASE
                WHEN asv.visit_oid::text = 'C1D1'::text THEN rand.visit_date_actl
                ELSE date(lsv.actual_visit_date + (acl.cycle_length * (asv."cycle" - lsv."cycle") + asv."day" - lsv."day" - asv.visit_window)::double precision * '1 day'::interval)
            END AND 
            CASE
                WHEN asv.visit_oid::text = 'C1D1'::text THEN date(rand.visit_date_actl + 7::double precision * '1 day'::interval)
                ELSE date(lsv.actual_visit_date + (acl.cycle_length * (asv."cycle" - lsv."cycle") + asv."day" - lsv."day" + asv.visit_window)::double precision * '1 day'::interval)
            END < 'now'::text::date THEN 'Y'::text
            WHEN lsv.actual_visit_date < 'now'::text::date THEN 'N'::text
            WHEN asv.sm_code::text ~~ '%SM13%'::text OR asv.labcorp_pvc::text = 'BMAMRDSLID'::text THEN 'N'::text
            ELSE NULL::text
        END AS pot_missing, 
        CASE
            WHEN asv.sm_code::text ~~ '%SM13%'::text OR asv.labcorp_pvc::text = 'BMAMRDSLID'::text THEN 'N'::text
            WHEN asv.not_mapped::text = 'Y'::text OR 
            CASE
                WHEN asv.specimen_id IS NOT NULL THEN 'Y'::text
                ELSE 'N'::text
            END = 'N'::text THEN 'Y'::text
            ELSE 'N'::text
        END AS review_item, md5((((((((asv.protocol_id::text || asv.site_id::text) || asv.subject_id::text) || COALESCE(asv.labcorp_pvc, ''::character varying)::text) || COALESCE(asv.visit_name, ''::character varying)::text) || COALESCE(asv.container_number, 0)::text) || COALESCE(asv.specimen_id, ''::character varying)::text) || COALESCE(asv.sm_description, ''::character varying)::text) || COALESCE(asv.visit_id, ''::character varying)::text) AS row_id
   FROM ( SELECT study.therapeutic_area AS ta, study_subject.study_id AS protocol_id, study_subject.subject_id, study_subject.study_subject_status AS subject_status, study_subject.study_arm, site.site_country_name AS country, site.site_name, site.investigator_name AS pi_name, es.cohort, COALESCE(es.labcorp_pvc, rs.visit_id::character varying) AS labcorp_pvc, COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid, es.label_line_1, COALESCE(es.sm_code, rs.sm_code) AS sm_code, COALESCE(es.sm_description, rs.sm_description) AS sm_description, rs.accession_number, COALESCE(es.container_number, rs.container_number) AS container_number, rs.receipt_temperature, rs.shipping_datetime, rs.shipping_destination, rs."sample_type", rs.specimen_collection_date AS collection_datetime, rv.visit_date_actl AS actual_visit_date, study_subject.site_id, ev.visit_window, es.aliquot, rs.specimen_id, rs.latest_modified_time, rv.visit_name AS visit_id, es.mandatory, NULL::"unknown" AS sample_manual_flag, COALESCE(ev."cycle", rv."cycle") AS "cycle", COALESCE(ev."day", rv."day") AS "day", 
                CASE
                    WHEN ev.cc_customized = true THEN (COALESCE(ev.labcorp_pvc_description, rv.visit_name)::text || COALESCE(' - '::text || ev.visit_name::text, ''::text))::character varying
                    ELSE COALESCE(ev.labcorp_pvc_description, rv.visit_name)
                END AS visit_name, 
                CASE
                    WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                    ELSE 'N'::text
                END::character varying AS not_mapped
           FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS "sample_type", specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, "replace"(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                   FROM orbit_64407564mmy3009.specimen specimen
              JOIN orbit_64407564mmy3009.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
         LEFT JOIN orbit_64407564mmy3009.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
      FULL JOIN ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                   FROM (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                           FROM orbit_64407564mmy3009.study_subject study_subject
                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.visit v
                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                              FROM orbit_64407564mmy3009.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1))
              UNION ALL 
                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
           WHERE ev.visit_oid::text <> 'SCREEN'::text
                UNION ALL 
                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                           FROM orbit_64407564mmy3009.study_subject study_subject
                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.visit v
                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                              FROM orbit_64407564mmy3009.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                UNION ALL 
                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                           FROM orbit_64407564mmy3009.study_subject study_subject
                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                   END::integer AS "cycle", 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                   END::integer AS "day"
                              FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
              JOIN orbit_64407564mmy3009.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es."region"::text = evs."region"::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es ON es.subject_id::text = rs.subject_id AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number
   LEFT JOIN (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
              FROM orbit_64407564mmy3009.study_subject study_subject
         LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
    LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS "cycle", 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS "day"
                         FROM orbit_64407564mmy3009.visit v
                    JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
            JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.visit v
                            JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                    LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                 FROM orbit_64407564mmy3009.site_amendment
                                WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                   WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                   GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
           WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
   JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                         END::integer AS "cycle", 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                         END::integer AS "day"
                    FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
           WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                    FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                 END::integer AS "cycle", 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                 END::integer AS "day"
                            FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                   WHERE expected_visits.amendment = 1))
 UNION ALL 
          SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                         END::integer AS "cycle", 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                         END::integer AS "day"
                    FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
           WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
  WHERE ev.visit_oid::text <> 'SCREEN'::text
   UNION ALL 
            SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
              FROM orbit_64407564mmy3009.study_subject study_subject
         LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
    LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS "cycle", 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS "day"
                         FROM orbit_64407564mmy3009.visit v
                    JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
            JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.visit v
                            JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                    LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                 FROM orbit_64407564mmy3009.site_amendment
                                WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                   WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                   GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
           WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
   JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                         END::integer AS "cycle", 
                         CASE
                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                         END::integer AS "day"
                    FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
           WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
  WHERE ev.visit_oid::text <> 'SCREEN'::text)
   UNION ALL 
            SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
              FROM orbit_64407564mmy3009.study_subject study_subject
         LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
    JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                      CASE
                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                      END::integer AS "cycle", 
                      CASE
                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                      END::integer AS "day"
                 FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
   WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND ev.labcorp_pvc::text = COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text
   LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
              CASE
                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
              END::integer AS "cycle", 
              CASE
                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
              END::integer AS "day"
         FROM orbit_64407564mmy3009.visit v
    JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND (rv."cycle" IS NOT NULL OR rv.visit_oid::text = 'SCREEN'::text OR rs.specimen_collection_date IS NULL OR date(rs.specimen_collection_date) = rv.visit_date_actl) AND rv.visit_oid::text = ev.visit_oid::text
   LEFT JOIN orbit_64407564mmy3009.study_subject study_subject ON COALESCE(rv.subject_id, rs.subject_id::character varying, es.subject_id)::text = study_subject.subject_id::text
   LEFT JOIN orbit_64407564mmy3009.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN orbit_64407564mmy3009.study ON study.study_id::text = study_subject.study_id::text
  WHERE COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'DE'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'CRS'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'NTX'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'SARR'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'PSDC'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'MMR'::text OR (EXISTS ( SELECT 1
   FROM ( SELECT rs.subject_id, rs.specimen_collection_date, rs.visit_id AS labcorp_pvc
           FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS "sample_type", specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, "replace"(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                   FROM orbit_64407564mmy3009.specimen specimen
              JOIN orbit_64407564mmy3009.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
         LEFT JOIN orbit_64407564mmy3009.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
          WHERE rs.visit_id = 'CRS'::text OR rs.visit_id = 'NTX'::text OR rs.visit_id = 'SARR'::text OR rs.visit_id = 'PSDC'::text OR rs.visit_id = 'MMR'::text) rc
  WHERE rc.subject_id = study_subject.subject_id::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text = rc.labcorp_pvc AND (rv.visit_date_actl IS NULL OR abs(date_diff('day'::text, rc.specimen_collection_date, rv.visit_date_actl::timestamp without time zone)) <= 1)))
UNION ALL 
         SELECT study.therapeutic_area AS ta, study_subject.study_id AS protocol_id, study_subject.subject_id, study_subject.study_subject_status AS subject_status, study_subject.study_arm, site.site_country_name AS country, site.site_name, site.investigator_name AS pi_name, es.cohort, COALESCE(es.labcorp_pvc, rs.visit_id::character varying) AS labcorp_pvc, COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid, es.label_line_1, COALESCE(es.sm_code, rs.sm_code) AS sm_code, COALESCE(es.sm_description, rs.sm_description) AS sm_description, rs.accession_number, COALESCE(es.container_number, rs.container_number) AS container_number, rs.receipt_temperature, rs.shipping_datetime, rs.shipping_destination, rs."sample_type", rs.specimen_collection_date AS collection_datetime, rv.visit_date_actl AS actual_visit_date, study_subject.site_id, 7 AS visit_window, es.aliquot, rs.specimen_id, rs.latest_modified_time, rv.visit_name AS visit_id, es.mandatory, es."cycle", es."day", NULL::"unknown" AS sample_manual_flag, COALESCE(ev.labcorp_pvc_description, rv.visit_name) AS visit_name, 
                CASE
                    WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                    ELSE 'N'::text
                END::character varying AS not_mapped
           FROM ( SELECT es.subject_id, es.labcorp_pvc, ev.labcorp_pvc_description, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort, ev.visit_oid, ev."cycle", ev."day", 7 AS visit_window
                   FROM ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                           FROM (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                      FROM orbit_64407564mmy3009.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1))
                      UNION ALL 
                               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
                   WHERE ev.visit_oid::text <> 'SCREEN'::text
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                      FROM orbit_64407564mmy3009.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
                   WHERE ev.visit_oid::text <> 'SCREEN'::text)
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
                      JOIN orbit_64407564mmy3009.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es."region"::text = evs."region"::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es
              LEFT JOIN (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                           FROM orbit_64407564mmy3009.study_subject study_subject
                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.visit v
                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                              FROM orbit_64407564mmy3009.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1))
              UNION ALL 
                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
           WHERE ev.visit_oid::text <> 'SCREEN'::text
                UNION ALL 
                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                           FROM orbit_64407564mmy3009.study_subject study_subject
                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.visit v
                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                              FROM orbit_64407564mmy3009.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                UNION ALL 
                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                           FROM orbit_64407564mmy3009.study_subject study_subject
                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                   END::integer AS "cycle", 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                   END::integer AS "day"
                              FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = es.subject_id::text
             WHERE es.labcorp_pvc::text = 'DE'::text AND (ev."day" = 1 OR ev.labcorp_pvc::text = 'DE'::text)) es
      LEFT JOIN (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                   FROM orbit_64407564mmy3009.study_subject study_subject
              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                   CASE
                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                   END::integer AS "cycle", 
                                   CASE
                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                   END::integer AS "day"
                              FROM orbit_64407564mmy3009.visit v
                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.visit v
                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                      FROM orbit_64407564mmy3009.site_amendment
                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS "cycle", 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS "day"
                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 1))
      UNION ALL 
               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS "cycle", 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS "day"
                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
   WHERE ev.visit_oid::text <> 'SCREEN'::text
        UNION ALL 
                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                   FROM orbit_64407564mmy3009.study_subject study_subject
              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                   CASE
                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                   END::integer AS "cycle", 
                                   CASE
                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                   END::integer AS "day"
                              FROM orbit_64407564mmy3009.visit v
                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.visit v
                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                      FROM orbit_64407564mmy3009.site_amendment
                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS "cycle", 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS "day"
                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
   WHERE ev.visit_oid::text <> 'SCREEN'::text)
        UNION ALL 
                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                   FROM orbit_64407564mmy3009.study_subject study_subject
              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                           CASE
                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                           END::integer AS "cycle", 
                           CASE
                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                           END::integer AS "day"
                      FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON es.subject_id::text = ev.subject_id::text AND es.labcorp_pvc::text = ev.labcorp_pvc::text
   LEFT JOIN ( SELECT received_deval_day1.visit_oid, received_deval_day1.subject_id, received_deval_day1.visit_date_actl, received_deval_day1.visit_name, received_deval_day1."cycle", received_deval_day1."day", received_deval_day1.rn
              FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1."cycle", derived_table1."day", derived_table1.rn
                      FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv."cycle", rv."day", pg_catalog.row_number()
                             OVER( 
                             PARTITION BY v.subject_id, rv."cycle"
                             ORDER BY date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone)) AS rn
                              FROM orbit_64407564mmy3009.visit v
                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                    LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.visit v
                            JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) AND date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) <= 7
                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv."day" = 1) derived_table1
                     WHERE derived_table1.rn = 1) received_deval_day1
   UNION ALL 
            SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, NULL::integer AS "cycle", NULL::integer AS "day", NULL::integer AS rn
              FROM orbit_64407564mmy3009.visit v
         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND NOT ((v.subject_id, v.visit_name) IN ( SELECT received_deval_day1.subject_id, received_deval_day1.visit_name
                 FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1."cycle", derived_table1."day", derived_table1.rn
                         FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv."cycle", rv."day", pg_catalog.row_number()
                                OVER( 
                                PARTITION BY v.subject_id, rv."cycle"
                                ORDER BY date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone)) AS rn
                                 FROM orbit_64407564mmy3009.visit v
                            JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                       LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                         CASE
                                             WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                         END::integer AS "cycle", 
                                         CASE
                                             WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                         END::integer AS "day"
                                    FROM orbit_64407564mmy3009.visit v
                               JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                              WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) AND date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) <= 7
                      WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv."day" = 1) derived_table1
                        WHERE derived_table1.rn = 1) received_deval_day1))) rv ON rv.subject_id::text = es.subject_id::text AND (rv."cycle" = es."cycle" OR rv."cycle" IS NULL AND es."cycle" IS NULL)
   LEFT JOIN ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS "sample_type", specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, "replace"(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
         FROM orbit_64407564mmy3009.specimen specimen
    JOIN orbit_64407564mmy3009.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
   LEFT JOIN orbit_64407564mmy3009.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs ON rs.subject_id = es.subject_id::text AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number AND abs(date_diff('day'::text, rs.specimen_collection_date, rv.visit_date_actl::timestamp without time zone)) <= 1
   LEFT JOIN orbit_64407564mmy3009.study_subject study_subject ON es.subject_id::text = study_subject.subject_id::text
   LEFT JOIN orbit_64407564mmy3009.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN orbit_64407564mmy3009.study ON study.study_id::text = study_subject.study_id::text) asv
   LEFT JOIN ( SELECT DISTINCT asv.subject_id, asv."cycle", asv."day", latest.actual_visit_date
           FROM ( SELECT study.therapeutic_area AS ta, study_subject.study_id AS protocol_id, study_subject.subject_id, study_subject.study_subject_status AS subject_status, study_subject.study_arm, site.site_country_name AS country, site.site_name, site.investigator_name AS pi_name, es.cohort, COALESCE(es.labcorp_pvc, rs.visit_id::character varying) AS labcorp_pvc, COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid, es.label_line_1, COALESCE(es.sm_code, rs.sm_code) AS sm_code, COALESCE(es.sm_description, rs.sm_description) AS sm_description, rs.accession_number, COALESCE(es.container_number, rs.container_number) AS container_number, rs.receipt_temperature, rs.shipping_datetime, rs.shipping_destination, rs."sample_type", rs.specimen_collection_date AS collection_datetime, rv.visit_date_actl AS actual_visit_date, study_subject.site_id, ev.visit_window, es.aliquot, rs.specimen_id, rs.latest_modified_time, rv.visit_name AS visit_id, es.mandatory, NULL::"unknown" AS sample_manual_flag, COALESCE(ev."cycle", rv."cycle") AS "cycle", COALESCE(ev."day", rv."day") AS "day", 
                        CASE
                            WHEN ev.cc_customized = true THEN (COALESCE(ev.labcorp_pvc_description, rv.visit_name)::text || COALESCE(' - '::text || ev.visit_name::text, ''::text))::character varying
                            ELSE COALESCE(ev.labcorp_pvc_description, rv.visit_name)
                        END AS visit_name, 
                        CASE
                            WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                            ELSE 'N'::text
                        END::character varying AS not_mapped
                   FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS "sample_type", specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, "replace"(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                           FROM orbit_64407564mmy3009.specimen specimen
                      JOIN orbit_64407564mmy3009.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
                 LEFT JOIN orbit_64407564mmy3009.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
              FULL JOIN ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                           FROM (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                      FROM orbit_64407564mmy3009.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1))
                      UNION ALL 
                               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
                   WHERE ev.visit_oid::text <> 'SCREEN'::text
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                      FROM orbit_64407564mmy3009.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
                   WHERE ev.visit_oid::text <> 'SCREEN'::text)
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
                      JOIN orbit_64407564mmy3009.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es."region"::text = evs."region"::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es ON es.subject_id::text = rs.subject_id AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number
         LEFT JOIN (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                      FROM orbit_64407564mmy3009.study_subject study_subject
                 LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
            LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.visit v
                            JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                    JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.visit v
                                    JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                            LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                         FROM orbit_64407564mmy3009.site_amendment
                                        WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                        GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                           WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                           GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                   WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
       JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                    FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                 END::integer AS "cycle", 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                 END::integer AS "day"
                            FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                   WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                         END::integer AS "cycle", 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                         END::integer AS "day"
                                    FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                           WHERE expected_visits.amendment = 1))
         UNION ALL 
                  SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                    FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                 END::integer AS "cycle", 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                 END::integer AS "day"
                            FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                   WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
      WHERE ev.visit_oid::text <> 'SCREEN'::text
           UNION ALL 
                    SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                      FROM orbit_64407564mmy3009.study_subject study_subject
                 LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
            LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.visit v
                            JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                    JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.visit v
                                    JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                            LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                         FROM orbit_64407564mmy3009.site_amendment
                                        WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                        GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                           WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                           GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                   WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
       JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                    FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                 END::integer AS "cycle", 
                                 CASE
                                     WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                     ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                 END::integer AS "day"
                            FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                   WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
      WHERE ev.visit_oid::text <> 'SCREEN'::text)
           UNION ALL 
                    SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                      FROM orbit_64407564mmy3009.study_subject study_subject
                 LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
            JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS "cycle", 
                              CASE
                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS "day"
                         FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
           WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND ev.labcorp_pvc::text = COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text
    LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                      CASE
                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                      END::integer AS "cycle", 
                      CASE
                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                      END::integer AS "day"
                 FROM orbit_64407564mmy3009.visit v
            JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND (rv."cycle" IS NOT NULL OR rv.visit_oid::text = 'SCREEN'::text OR rs.specimen_collection_date IS NULL OR date(rs.specimen_collection_date) = rv.visit_date_actl) AND rv.visit_oid::text = ev.visit_oid::text
   LEFT JOIN orbit_64407564mmy3009.study_subject study_subject ON COALESCE(rv.subject_id, rs.subject_id::character varying, es.subject_id)::text = study_subject.subject_id::text
   LEFT JOIN orbit_64407564mmy3009.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN orbit_64407564mmy3009.study ON study.study_id::text = study_subject.study_id::text
  WHERE COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'DE'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'CRS'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'NTX'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'SARR'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'PSDC'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'MMR'::text OR (EXISTS ( SELECT 1
   FROM ( SELECT rs.subject_id, rs.specimen_collection_date, rs.visit_id AS labcorp_pvc
           FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS "sample_type", specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, "replace"(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                   FROM orbit_64407564mmy3009.specimen specimen
              JOIN orbit_64407564mmy3009.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
         LEFT JOIN orbit_64407564mmy3009.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
          WHERE rs.visit_id = 'CRS'::text OR rs.visit_id = 'NTX'::text OR rs.visit_id = 'SARR'::text OR rs.visit_id = 'PSDC'::text OR rs.visit_id = 'MMR'::text) rc
  WHERE rc.subject_id = study_subject.subject_id::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text = rc.labcorp_pvc AND (rv.visit_date_actl IS NULL OR abs(date_diff('day'::text, rc.specimen_collection_date, rv.visit_date_actl::timestamp without time zone)) <= 1)))
        UNION ALL 
                 SELECT study.therapeutic_area AS ta, study_subject.study_id AS protocol_id, study_subject.subject_id, study_subject.study_subject_status AS subject_status, study_subject.study_arm, site.site_country_name AS country, site.site_name, site.investigator_name AS pi_name, es.cohort, COALESCE(es.labcorp_pvc, rs.visit_id::character varying) AS labcorp_pvc, COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid, es.label_line_1, COALESCE(es.sm_code, rs.sm_code) AS sm_code, COALESCE(es.sm_description, rs.sm_description) AS sm_description, rs.accession_number, COALESCE(es.container_number, rs.container_number) AS container_number, rs.receipt_temperature, rs.shipping_datetime, rs.shipping_destination, rs."sample_type", rs.specimen_collection_date AS collection_datetime, rv.visit_date_actl AS actual_visit_date, study_subject.site_id, 7 AS visit_window, es.aliquot, rs.specimen_id, rs.latest_modified_time, rv.visit_name AS visit_id, es.mandatory, es."cycle", es."day", NULL::"unknown" AS sample_manual_flag, COALESCE(ev.labcorp_pvc_description, rv.visit_name) AS visit_name, 
                        CASE
                            WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                            ELSE 'N'::text
                        END::character varying AS not_mapped
                   FROM ( SELECT es.subject_id, es.labcorp_pvc, ev.labcorp_pvc_description, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort, ev.visit_oid, ev."cycle", ev."day", 7 AS visit_window
                           FROM ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                                   FROM (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                           FROM orbit_64407564mmy3009.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "cycle", 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "day"
                                                              FROM orbit_64407564mmy3009.visit v
                                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                              FROM orbit_64407564mmy3009.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "cycle", 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "day"
                                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 1))
                              UNION ALL 
                                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
                           WHERE ev.visit_oid::text <> 'SCREEN'::text
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                           FROM orbit_64407564mmy3009.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "cycle", 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "day"
                                                              FROM orbit_64407564mmy3009.visit v
                                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                              FROM orbit_64407564mmy3009.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
                           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                           FROM orbit_64407564mmy3009.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
                              JOIN orbit_64407564mmy3009.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es."region"::text = evs."region"::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es
                      LEFT JOIN (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                      FROM orbit_64407564mmy3009.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1))
                      UNION ALL 
                               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
                   WHERE ev.visit_oid::text <> 'SCREEN'::text
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                      FROM orbit_64407564mmy3009.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
                   WHERE ev.visit_oid::text <> 'SCREEN'::text)
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = es.subject_id::text
                     WHERE es.labcorp_pvc::text = 'DE'::text AND (ev."day" = 1 OR ev.labcorp_pvc::text = 'DE'::text)) es
              LEFT JOIN (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                           FROM orbit_64407564mmy3009.study_subject study_subject
                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.visit v
                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                              FROM orbit_64407564mmy3009.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1))
              UNION ALL 
                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
           WHERE ev.visit_oid::text <> 'SCREEN'::text
                UNION ALL 
                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                           FROM orbit_64407564mmy3009.study_subject study_subject
                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.visit v
                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                              FROM orbit_64407564mmy3009.site_amendment
                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                        WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                UNION ALL 
                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                           FROM orbit_64407564mmy3009.study_subject study_subject
                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                   END::integer AS "cycle", 
                                   CASE
                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                   END::integer AS "day"
                              FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON es.subject_id::text = ev.subject_id::text AND es.labcorp_pvc::text = ev.labcorp_pvc::text
         LEFT JOIN ( SELECT received_deval_day1.visit_oid, received_deval_day1.subject_id, received_deval_day1.visit_date_actl, received_deval_day1.visit_name, received_deval_day1."cycle", received_deval_day1."day", received_deval_day1.rn
                      FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1."cycle", derived_table1."day", derived_table1.rn
                              FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv."cycle", rv."day", pg_catalog.row_number()
                                     OVER( 
                                     PARTITION BY v.subject_id, rv."cycle"
                                     ORDER BY date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone)) AS rn
                                      FROM orbit_64407564mmy3009.visit v
                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                            LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.visit v
                                    JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) AND date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) <= 7
                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv."day" = 1) derived_table1
                             WHERE derived_table1.rn = 1) received_deval_day1
           UNION ALL 
                    SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, NULL::integer AS "cycle", NULL::integer AS "day", NULL::integer AS rn
                      FROM orbit_64407564mmy3009.visit v
                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND NOT ((v.subject_id, v.visit_name) IN ( SELECT received_deval_day1.subject_id, received_deval_day1.visit_name
                         FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1."cycle", derived_table1."day", derived_table1.rn
                                 FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv."cycle", rv."day", pg_catalog.row_number()
                                        OVER( 
                                        PARTITION BY v.subject_id, rv."cycle"
                                        ORDER BY date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone)) AS rn
                                         FROM orbit_64407564mmy3009.visit v
                                    JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                               LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                 CASE
                                                     WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                     ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                 END::integer AS "cycle", 
                                                 CASE
                                                     WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                     ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                 END::integer AS "day"
                                            FROM orbit_64407564mmy3009.visit v
                                       JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                      WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) AND date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) <= 7
                              WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv."day" = 1) derived_table1
                                WHERE derived_table1.rn = 1) received_deval_day1))) rv ON rv.subject_id::text = es.subject_id::text AND (rv."cycle" = es."cycle" OR rv."cycle" IS NULL AND es."cycle" IS NULL)
    LEFT JOIN ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS "sample_type", specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, "replace"(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                 FROM orbit_64407564mmy3009.specimen specimen
            JOIN orbit_64407564mmy3009.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
       LEFT JOIN orbit_64407564mmy3009.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs ON rs.subject_id = es.subject_id::text AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number AND abs(date_diff('day'::text, rs.specimen_collection_date, rv.visit_date_actl::timestamp without time zone)) <= 1
   LEFT JOIN orbit_64407564mmy3009.study_subject study_subject ON es.subject_id::text = study_subject.subject_id::text
   LEFT JOIN orbit_64407564mmy3009.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN orbit_64407564mmy3009.study ON study.study_id::text = study_subject.study_id::text) asv
      JOIN ( SELECT all_samples_visits.subject_id, "max"(all_samples_visits.actual_visit_date) AS actual_visit_date
                   FROM ( SELECT study.therapeutic_area AS ta, study_subject.study_id AS protocol_id, study_subject.subject_id, study_subject.study_subject_status AS subject_status, study_subject.study_arm, site.site_country_name AS country, site.site_name, site.investigator_name AS pi_name, es.cohort, COALESCE(es.labcorp_pvc, rs.visit_id::character varying) AS labcorp_pvc, COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid, es.label_line_1, COALESCE(es.sm_code, rs.sm_code) AS sm_code, COALESCE(es.sm_description, rs.sm_description) AS sm_description, rs.accession_number, COALESCE(es.container_number, rs.container_number) AS container_number, rs.receipt_temperature, rs.shipping_datetime, rs.shipping_destination, rs."sample_type", rs.specimen_collection_date AS collection_datetime, rv.visit_date_actl AS actual_visit_date, study_subject.site_id, ev.visit_window, es.aliquot, rs.specimen_id, rs.latest_modified_time, rv.visit_name AS visit_id, es.mandatory, NULL::"unknown" AS sample_manual_flag, COALESCE(ev."cycle", rv."cycle") AS "cycle", COALESCE(ev."day", rv."day") AS "day", 
                                CASE
                                    WHEN ev.cc_customized = true THEN (COALESCE(ev.labcorp_pvc_description, rv.visit_name)::text || COALESCE(' - '::text || ev.visit_name::text, ''::text))::character varying
                                    ELSE COALESCE(ev.labcorp_pvc_description, rv.visit_name)
                                END AS visit_name, 
                                CASE
                                    WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                                    ELSE 'N'::text
                                END::character varying AS not_mapped
                           FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS "sample_type", specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, "replace"(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                                   FROM orbit_64407564mmy3009.specimen specimen
                              JOIN orbit_64407564mmy3009.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
                         LEFT JOIN orbit_64407564mmy3009.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
                      FULL JOIN ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                                   FROM (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                           FROM orbit_64407564mmy3009.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "cycle", 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "day"
                                                              FROM orbit_64407564mmy3009.visit v
                                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                              FROM orbit_64407564mmy3009.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "cycle", 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "day"
                                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 1))
                              UNION ALL 
                                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
                           WHERE ev.visit_oid::text <> 'SCREEN'::text
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                           FROM orbit_64407564mmy3009.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "cycle", 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "day"
                                                              FROM orbit_64407564mmy3009.visit v
                                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                              FROM orbit_64407564mmy3009.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
                           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                           FROM orbit_64407564mmy3009.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
                              JOIN orbit_64407564mmy3009.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es."region"::text = evs."region"::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es ON es.subject_id::text = rs.subject_id AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number
                 LEFT JOIN (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                              FROM orbit_64407564mmy3009.study_subject study_subject
                         LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                    LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.visit v
                                    JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                            JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.visit v
                                            JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                    LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                 FROM orbit_64407564mmy3009.site_amendment
                                                WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                   WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                   GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                           WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
               JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                         END::integer AS "cycle", 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                         END::integer AS "day"
                                    FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                           WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                    FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                 CASE
                                                     WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                     ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                 END::integer AS "cycle", 
                                                 CASE
                                                     WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                     ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                 END::integer AS "day"
                                            FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                   WHERE expected_visits.amendment = 1))
                 UNION ALL 
                          SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                         END::integer AS "cycle", 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                         END::integer AS "day"
                                    FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                           WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
              WHERE ev.visit_oid::text <> 'SCREEN'::text
                   UNION ALL 
                            SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                              FROM orbit_64407564mmy3009.study_subject study_subject
                         LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                    LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                 FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.visit v
                                    JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                            JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                         FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.visit v
                                            JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                    LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                 FROM orbit_64407564mmy3009.site_amendment
                                                WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                   WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                   GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                           WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
               JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                            FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                         END::integer AS "cycle", 
                                         CASE
                                             WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                             ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                         END::integer AS "day"
                                    FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                           WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
              WHERE ev.visit_oid::text <> 'SCREEN'::text)
                   UNION ALL 
                            SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                              FROM orbit_64407564mmy3009.study_subject study_subject
                         LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                    JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                      END::integer AS "cycle", 
                                      CASE
                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                      END::integer AS "day"
                                 FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                   WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND ev.labcorp_pvc::text = COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text
            LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                              END::integer AS "cycle", 
                              CASE
                                  WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                  ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                              END::integer AS "day"
                         FROM orbit_64407564mmy3009.visit v
                    JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = COALESCE(es.subject_id, rs.subject_id::character varying)::text AND (rv."cycle" IS NOT NULL OR rv.visit_oid::text = 'SCREEN'::text OR rs.specimen_collection_date IS NULL OR date(rs.specimen_collection_date) = rv.visit_date_actl) AND rv.visit_oid::text = ev.visit_oid::text
       LEFT JOIN orbit_64407564mmy3009.study_subject study_subject ON COALESCE(rv.subject_id, rs.subject_id::character varying, es.subject_id)::text = study_subject.subject_id::text
   LEFT JOIN orbit_64407564mmy3009.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN orbit_64407564mmy3009.study ON study.study_id::text = study_subject.study_id::text
  WHERE COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'DE'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'CRS'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'NTX'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'SARR'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'PSDC'::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text <> 'MMR'::text OR (EXISTS ( SELECT 1
     FROM ( SELECT rs.subject_id, rs.specimen_collection_date, rs.visit_id AS labcorp_pvc
             FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS "sample_type", specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, "replace"(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                     FROM orbit_64407564mmy3009.specimen specimen
                JOIN orbit_64407564mmy3009.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
           LEFT JOIN orbit_64407564mmy3009.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs
            WHERE rs.visit_id = 'CRS'::text OR rs.visit_id = 'NTX'::text OR rs.visit_id = 'SARR'::text OR rs.visit_id = 'PSDC'::text OR rs.visit_id = 'MMR'::text) rc
    WHERE rc.subject_id = study_subject.subject_id::text AND COALESCE(es.labcorp_pvc, rs.visit_id::character varying)::text = rc.labcorp_pvc AND (rv.visit_date_actl IS NULL OR abs(date_diff('day'::text, rc.specimen_collection_date, rv.visit_date_actl::timestamp without time zone)) <= 1)))
                UNION ALL 
                         SELECT study.therapeutic_area AS ta, study_subject.study_id AS protocol_id, study_subject.subject_id, study_subject.study_subject_status AS subject_status, study_subject.study_arm, site.site_country_name AS country, site.site_name, site.investigator_name AS pi_name, es.cohort, COALESCE(es.labcorp_pvc, rs.visit_id::character varying) AS labcorp_pvc, COALESCE(ev.visit_oid, rv.visit_oid) AS visit_oid, es.label_line_1, COALESCE(es.sm_code, rs.sm_code) AS sm_code, COALESCE(es.sm_description, rs.sm_description) AS sm_description, rs.accession_number, COALESCE(es.container_number, rs.container_number) AS container_number, rs.receipt_temperature, rs.shipping_datetime, rs.shipping_destination, rs."sample_type", rs.specimen_collection_date AS collection_datetime, rv.visit_date_actl AS actual_visit_date, study_subject.site_id, 7 AS visit_window, es.aliquot, rs.specimen_id, rs.latest_modified_time, rv.visit_name AS visit_id, es.mandatory, es."cycle", es."day", NULL::"unknown" AS sample_manual_flag, COALESCE(ev.labcorp_pvc_description, rv.visit_name) AS visit_name, 
                                CASE
                                    WHEN es.container_number IS NULL AND rs.container_number IS NOT NULL THEN 'Y'::text
                                    ELSE 'N'::text
                                END::character varying AS not_mapped
                           FROM ( SELECT es.subject_id, es.labcorp_pvc, ev.labcorp_pvc_description, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort, ev.visit_oid, ev."cycle", ev."day", 7 AS visit_window
                                   FROM ( SELECT evs.subject_id, es.labcorp_pvc, es.container_number, es.sm_code, es.sm_description, es.label_line_1, es.aliquot, es.mandatory, es.cohort
                                           FROM (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                                   FROM orbit_64407564mmy3009.study_subject study_subject
                                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "cycle", 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "day"
                                                              FROM orbit_64407564mmy3009.visit v
                                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                           CASE
                                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                           END::integer AS "cycle", 
                                                                           CASE
                                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                           END::integer AS "day"
                                                                      FROM orbit_64407564mmy3009.visit v
                                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                                      FROM orbit_64407564mmy3009.site_amendment
                                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "cycle", 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "day"
                                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                                      CASE
                                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                      END::integer AS "cycle", 
                                                                      CASE
                                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                      END::integer AS "day"
                                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                                        WHERE expected_visits.amendment = 1))
                                      UNION ALL 
                                               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "cycle", 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "day"
                                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
                                   WHERE ev.visit_oid::text <> 'SCREEN'::text
                                        UNION ALL 
                                                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                                   FROM orbit_64407564mmy3009.study_subject study_subject
                                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "cycle", 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "day"
                                                              FROM orbit_64407564mmy3009.visit v
                                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                           CASE
                                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                           END::integer AS "cycle", 
                                                                           CASE
                                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                           END::integer AS "day"
                                                                      FROM orbit_64407564mmy3009.visit v
                                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                                      FROM orbit_64407564mmy3009.site_amendment
                                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "cycle", 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "day"
                                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
                                   WHERE ev.visit_oid::text <> 'SCREEN'::text)
                                        UNION ALL 
                                                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                                   FROM orbit_64407564mmy3009.study_subject study_subject
                                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                           CASE
                                                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                                        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) evs
                                      JOIN orbit_64407564mmy3009.expected_s es ON es.labcorp_pvc::text = evs.labcorp_pvc::text AND es."region"::text = evs."region"::text AND es.study_arm::text = evs.study_arm::text AND es.amendment::text = evs.amendment::text) es
                              LEFT JOIN (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                           FROM orbit_64407564mmy3009.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "cycle", 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "day"
                                                              FROM orbit_64407564mmy3009.visit v
                                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                              FROM orbit_64407564mmy3009.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "cycle", 
                                                              CASE
                                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                              END::integer AS "day"
                                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                                WHERE expected_visits.amendment = 1))
                              UNION ALL 
                                       SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
                           WHERE ev.visit_oid::text <> 'SCREEN'::text
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                           FROM orbit_64407564mmy3009.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                 LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "cycle", 
                                                                   CASE
                                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                                   END::integer AS "day"
                                                              FROM orbit_64407564mmy3009.visit v
                                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                                 LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                              FROM orbit_64407564mmy3009.site_amendment
                                                             WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                             GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                                WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                                GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                        WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                            JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
                           WHERE ev.visit_oid::text <> 'SCREEN'::text)
                                UNION ALL 
                                         SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                           FROM orbit_64407564mmy3009.study_subject study_subject
                                      LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                                 JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                                WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON ev.subject_id::text = es.subject_id::text
                             WHERE es.labcorp_pvc::text = 'DE'::text AND (ev."day" = 1 OR ev.labcorp_pvc::text = 'DE'::text)) es
                      LEFT JOIN (( SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                      FROM orbit_64407564mmy3009.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2 AND NOT ((expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm) IN ( SELECT DISTINCT expected_visits.labcorp_pvc, expected_visits."region", expected_visits.study_arm
                                         FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                        WHERE expected_visits.amendment = 1))
                      UNION ALL 
                               SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 1) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND ev."cycle" IS NOT NULL AND (ev."cycle" < lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" <= lav."day")
                   WHERE ev.visit_oid::text <> 'SCREEN'::text
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         LEFT JOIN ( SELECT DISTINCT rv.visit_oid, rv.subject_id, latest.visit_date_actl, rv.visit_name, rv."cycle", rv."day"
                                      FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "cycle", 
                                                   CASE
                                                       WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                       ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                   END::integer AS "day"
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                 JOIN ( SELECT rv.subject_id, "max"(rv.visit_date_actl) AS visit_date_actl
                                              FROM ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "cycle", 
                                                           CASE
                                                               WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                               ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                           END::integer AS "day"
                                                      FROM orbit_64407564mmy3009.visit v
                                                 JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                                WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv
                                         LEFT JOIN ( SELECT site_amendment.site_id, "max"(site_amendment.date_updated) AS date_updated
                                                      FROM orbit_64407564mmy3009.site_amendment
                                                     WHERE site_amendment.new_amendment::text = 'GlobalProtocolAmendment2'::text
                                                     GROUP BY site_amendment.site_id) sad ON "right"(sad.site_id::text, 7) = "left"(rv.subject_id::text, 7)
                                        WHERE rv."cycle" IS NOT NULL AND rv.visit_date_actl <= sad.date_updated
                                        GROUP BY rv.subject_id) latest ON rv.subject_id::text = latest.subject_id::text AND rv.visit_date_actl = latest.visit_date_actl
                                WHERE rv."cycle" IS NOT NULL) lav ON lav.subject_id::text = study_subject.subject_id::text
                    JOIN ( SELECT expected_visits.labcorp_pvc, expected_visits.labcorp_pvc_description, expected_visits."region", expected_visits.study_arm, expected_visits.amendment, expected_visits.visit_oid, expected_visits.visit_name, expected_visits.visit_window, expected_visits.visit_requirements, expected_visits.cc_customized, expected_visits."cycle", expected_visits."day"
                                 FROM ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                              END::integer AS "cycle", 
                                              CASE
                                                  WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                  ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                              END::integer AS "day"
                                         FROM orbit_64407564mmy3009.expected_visits ev) expected_visits
                                WHERE expected_visits.amendment = 2) ev ON ev."region"::text = country_region."region"::text AND ev.study_arm::text = study_subject.study_arm::text AND (ev."cycle" IS NULL OR lav."cycle" IS NULL OR lav."day" IS NULL OR ev."cycle" > lav."cycle" OR ev."cycle" = lav."cycle" AND ev."day" > lav."day")
                   WHERE ev.visit_oid::text <> 'SCREEN'::text)
                        UNION ALL 
                                 SELECT study_subject.subject_id, ev."region", ev.study_arm, ev.labcorp_pvc, ev.visit_oid, ev.labcorp_pvc_description, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.amendment, ev."cycle", ev."day", ev.cc_customized
                                   FROM orbit_64407564mmy3009.study_subject study_subject
                              LEFT JOIN orbit.country_region ON "left"(study_subject.subject_id::text, 2) = country_region.country::text
                         JOIN ( SELECT ev.labcorp_pvc, ev.labcorp_pvc_description, ev."region", ev.study_arm, ev.amendment, ev.visit_oid, ev.visit_name, ev.visit_window, ev.visit_requirements, ev.cc_customized, 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                           END::integer AS "cycle", 
                                           CASE
                                               WHEN regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                               ELSE regexp_substr(ev.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                           END::integer AS "day"
                                      FROM orbit_64407564mmy3009.expected_visits ev) ev ON ev."region"::text = country_region."region"::text
                        WHERE ev.visit_oid::text = 'SCREEN'::text AND ev.study_arm::text = 'Arm A (Tal-P)'::text) ev ON es.subject_id::text = ev.subject_id::text AND es.labcorp_pvc::text = ev.labcorp_pvc::text
                 LEFT JOIN ( SELECT received_deval_day1.visit_oid, received_deval_day1.subject_id, received_deval_day1.visit_date_actl, received_deval_day1.visit_name, received_deval_day1."cycle", received_deval_day1."day", received_deval_day1.rn
                              FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1."cycle", derived_table1."day", derived_table1.rn
                                      FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv."cycle", rv."day", pg_catalog.row_number()
                                             OVER( 
                                             PARTITION BY v.subject_id, rv."cycle"
                                             ORDER BY date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone)) AS rn
                                              FROM orbit_64407564mmy3009.visit v
                                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                    LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "cycle", 
                                                      CASE
                                                          WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                          ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                      END::integer AS "day"
                                                 FROM orbit_64407564mmy3009.visit v
                                            JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                           WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) AND date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) <= 7
                                   WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv."day" = 1) derived_table1
                                     WHERE derived_table1.rn = 1) received_deval_day1
                   UNION ALL 
                            SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, NULL::integer AS "cycle", NULL::integer AS "day", NULL::integer AS rn
                              FROM orbit_64407564mmy3009.visit v
                         JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                        WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND NOT ((v.subject_id, v.visit_name) IN ( SELECT received_deval_day1.subject_id, received_deval_day1.visit_name
                                 FROM ( SELECT derived_table1.visit_oid, derived_table1.subject_id, derived_table1.visit_date_actl, derived_table1.visit_name, derived_table1."cycle", derived_table1."day", derived_table1.rn
                                         FROM ( SELECT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, rv."cycle", rv."day", pg_catalog.row_number()
                                                OVER( 
                                                PARTITION BY v.subject_id, rv."cycle"
                                                ORDER BY date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone)) AS rn
                                                 FROM orbit_64407564mmy3009.visit v
                                            JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                       LEFT JOIN ( SELECT DISTINCT v.visit_oid, v.subject_id, v.visit_date_actl, v.visit_name, 
                                                         CASE
                                                             WHEN regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                             ELSE regexp_substr(v.visit_oid::text, 'C(\\d+)D\\d+'::text, 1, 1, 'ie'::text)
                                                         END::integer AS "cycle", 
                                                         CASE
                                                             WHEN regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text) = ''::text THEN NULL::text
                                                             ELSE regexp_substr(v.visit_oid::text, 'C\\d+D(\\d+)'::text, 1, 1, 'ie'::text)
                                                         END::integer AS "day"
                                                    FROM orbit_64407564mmy3009.visit v
                                               JOIN orbit_64407564mmy3009.row_source_data_study_vw rsds ON v.row_id::text = rsds.row_id::text
                                              WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text <> 'DEVALVIS'::text) rv ON rv.subject_id::text = v.subject_id::text AND 0 <= date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) AND date_diff('day'::text, rv.visit_date_actl::timestamp without time zone, v.visit_date_actl::timestamp without time zone) <= 7
                                      WHERE rsds.dataset_name::text = 'edcom_visit'::text AND v.visit_date_actl IS NOT NULL AND v.visit_oid::text = 'DEVALVIS'::text AND rv."day" = 1) derived_table1
                                        WHERE derived_table1.rn = 1) received_deval_day1))) rv ON rv.subject_id::text = es.subject_id::text AND (rv."cycle" = es."cycle" OR rv."cycle" IS NULL AND es."cycle" IS NULL)
            LEFT JOIN ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS "sample_type", specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, "replace"(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
                         FROM orbit_64407564mmy3009.specimen specimen
                    JOIN orbit_64407564mmy3009.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
               LEFT JOIN orbit_64407564mmy3009.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) rs ON rs.subject_id = es.subject_id::text AND rs.visit_id = es.labcorp_pvc::text AND rs.container_number = es.container_number AND abs(date_diff('day'::text, rs.specimen_collection_date, rv.visit_date_actl::timestamp without time zone)) <= 1
       LEFT JOIN orbit_64407564mmy3009.study_subject study_subject ON es.subject_id::text = study_subject.subject_id::text
   LEFT JOIN orbit_64407564mmy3009.site site ON study_subject.site_id::text = site.site_id::text
   LEFT JOIN orbit_64407564mmy3009.study ON study.study_id::text = study_subject.study_id::text) all_samples_visits
                  WHERE all_samples_visits."cycle" IS NOT NULL AND all_samples_visits."day" IS NOT NULL
                  GROUP BY all_samples_visits.subject_id) latest ON asv.subject_id::text = latest.subject_id::text AND asv.actual_visit_date = latest.actual_visit_date
     WHERE asv."cycle" IS NOT NULL AND asv."day" IS NOT NULL) lsv ON asv.subject_id::text = lsv.subject_id::text
   LEFT JOIN ( SELECT visit.subject_id, visit.visit_date_actl
      FROM orbit_64407564mmy3009.visit
     WHERE visit.visit_type::text = 'DRM_ZR'::text) rand ON "replace"(rand.subject_id::text, 'AL8'::text, ''::text) = asv.subject_id::text
   LEFT JOIN ((( SELECT 'Arm A (Tal-P)' AS study_arm, 28 AS cycle_length
UNION ALL 
 SELECT 'Arm B (Tal-Tec)', 28)
UNION ALL 
 SELECT 'Arm C (EPd)', 28)
UNION ALL 
 SELECT 'Arm C (PVd)', 21) acl ON asv.study_arm::text = acl.study_arm::text
   LEFT JOIN ( SELECT received_samples.sm_description, "max"(received_samples."sample_type"::text) AS "sample_type"
   FROM ( SELECT specimen.specimen_collection_date, specimen.specimen_id, specimen.specimen_status, specimen.accession_number, specimen.vendor_specimen_type AS sm_code, specimen.specimen_type AS "sample_type", specimen.specimen_class AS sm_description, specimen.specimen_condition AS receipt_temperature, specimen_event.event_destination AS shipping_destination, specimen_event.event_start_date AS shipping_datetime, row_source.latest_modified_time, split_part(specimen.specimen_id::text, '-'::text, 2)::integer AS container_number, "replace"(specimen.subject_id::text, 'AL8'::text, ''::text) AS subject_id, split_part(specimen.visit_id::text, '|'::text, 1) AS visit_id
           FROM orbit_64407564mmy3009.specimen specimen
      JOIN orbit_64407564mmy3009.row_source_data_study_vw row_source ON row_source.row_id::text = specimen.row_id::text AND row_source.dataset_name::text = 'Labcorp_ST_64407564MMY3009'::text AND row_source.table_name::text = 'specimen'::text
   LEFT JOIN orbit_64407564mmy3009.specimen_event specimen_event ON specimen.specimen_id::text = specimen_event.specimen_id::text AND specimen_event.event_category::text = 'Sample Shipping'::text) received_samples
  GROUP BY received_samples.sm_description) rt ON asv.sm_description::text = rt.sm_description::text
  WHERE (asv.mandatory = true AND asv.sm_code::text <> ''::text OR 
CASE
    WHEN asv.specimen_id IS NOT NULL THEN 'Y'::text
    ELSE 'N'::text
END = 'Y'::text) AND (
CASE
    WHEN asv.visit_oid::text = 'C1D1'::text THEN date(rand.visit_date_actl + 7::double precision * '1 day'::interval)
    ELSE date(lsv.actual_visit_date + (acl.cycle_length * (asv."cycle" - lsv."cycle") + asv."day" - lsv."day" + asv.visit_window)::double precision * '1 day'::interval)
END < 'now'::text::date OR asv.actual_visit_date IS NOT NULL OR asv.collection_datetime IS NOT NULL) AND asv.sm_code::text <> 'SM11/PBMC'::text AND asv.sm_code::text <> 'SM12/MRD BMA'::text;

_________________________
-- orbit_64407564mmy3009.shipping_error_vw source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.shipping_error_vw
AS SELECT DISTINCT s.specimen_id, s.accession_number, s.study_subject, s.study_id, s.subject_id, s.pre_screening_id, s.visit_id, s.vendor_id, s.specimen_class, s.specimen_type, s.storage_location, s.storage_state, s.storage_temperature, s.vendor_specimen_id, s.vendor_subject_id, s.vendor_study_id, s.site_specimen_id, s.specimen_condition, s.specimen_extract_location, s.specimen_collection_date, s.specimen_received_date, s.vendor_specimen_type, s.specimen_status, s.specimen_accession_date, s.specimen_reporting_date, s.repeat_status, s.repeat_times, s.number_of_slides, s.number_of_slides_needed, s.reason_qualified_or_failed, s.sample_pass_fail_status, s.run_id, s.composite_primary_key, s.row_id, t.site_id, t.site_name, t.investigator_name, t.site_city, t.site_state, t.site_postcode, t.site_country_code, t.site_country_name, 
        CASE
            WHEN lower(s.specimen_class::text) ~~ '%re-receipt%'::text THEN 'Labcorp Re-Receipt'::text
            ELSE 'Incorrect Destination (Labcorp)'::text
        END AS issue_type
   FROM orbit_64407564mmy3009.specimen s
   JOIN orbit_64407564mmy3009.study_subject ss ON s.subject_id::text = ss.subject_id::text
   LEFT JOIN orbit_64407564mmy3009.site t ON ss.site_id::text = t.site_id::text
  WHERE (lower(s.specimen_class::text) ~~ '%wb%'::text OR lower(s.specimen_class::text) ~~ '%bma%'::text) AND lower(s.specimen_class::text) ~~ '%immunophenotyping%'::text;
___________________________________
-- orbit_64407564mmy3009.site source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.site
AS SELECT site.study_id, site.site_id, site.site_name, site.investigator_name, site.site_city, site.site_state, site.site_postcode, site.site_country_code, site.site_country_name, site.run_id, site.row_id
   FROM orbit.site
  WHERE (site.site_id IN ( SELECT study_site.site_id
           FROM orbit_64407564mmy3009.study_site
          GROUP BY study_site.site_id));
___________________________
-- orbit_64407564mmy3009.specimen_genomic_assay source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.specimen_genomic_assay
AS SELECT specimen_genomic_assay.specimen_genomic_assay_id, specimen_genomic_assay.specimen_id, specimen_genomic_assay.genomic_assay_id, specimen_genomic_assay.median_exon_coverage, specimen_genomic_assay.run_id, specimen_genomic_assay.row_id
   FROM orbit.specimen_genomic_assay
  WHERE (specimen_genomic_assay.specimen_id IN (( SELECT specimen.specimen_id
           FROM orbit_64407564mmy3009.specimen
          GROUP BY specimen.specimen_id
UNION 
         SELECT specimen_biomarker_pgx_finding.specimen_id
           FROM orbit_64407564mmy3009.specimen_biomarker_pgx_finding
          GROUP BY specimen_biomarker_pgx_finding.specimen_id)
UNION 
         SELECT specimen_pgx_finding.specimen_id
           FROM orbit_64407564mmy3009.specimen_pgx_finding
          GROUP BY specimen_pgx_finding.specimen_id));
___________________________
-- orbit_64407564mmy3009.specimen_lineage_origin source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.specimen_lineage_origin
AS WITH RECURSIVE hierarchical_relationship(study_id, vendor_id_source_origin, specimen_id_source_origin, vendor_id_target, specimen_id_target, lineage_path) AS (
         SELECT specimen_lineage.study_id, specimen_lineage.vendor_id_source AS vendor_id_source_origin, specimen_lineage.specimen_id_source AS specimen_id_source_origin, specimen_lineage.vendor_id_target, specimen_lineage.specimen_id_target, ((specimen_lineage.specimen_id_source::text || ' | '::text) || specimen_lineage.vendor_id_source::text)::character varying AS lineage_path
           FROM orbit_64407564mmy3009.specimen_lineage
          WHERE NOT (specimen_lineage.specimen_id_source IN ( SELECT COALESCE(specimen_lineage.specimen_id_target, ''::character varying) AS specimen_id_target
                   FROM orbit_64407564mmy3009.specimen_lineage))
UNION ALL 
         SELECT sl.study_id, hr.vendor_id_source_origin, hr.specimen_id_source_origin, sl.vendor_id_target, sl.specimen_id_target, ((((hr.lineage_path::text || ' -> '::text) || sl.specimen_id_source::text) || ' | '::text) || sl.vendor_id_source::text)::character varying AS lineage_path
           FROM orbit_64407564mmy3009.specimen_lineage sl
      JOIN hierarchical_relationship hr ON sl.specimen_id_source::text = hr.specimen_id_target::text
        )
 SELECT hierarchical_relationship.study_id, hierarchical_relationship.vendor_id_source_origin, hierarchical_relationship.specimen_id_source_origin, hierarchical_relationship.vendor_id_target, hierarchical_relationship.specimen_id_target, (((hierarchical_relationship.lineage_path::text || ' -> '::text) || hierarchical_relationship.specimen_id_target::text) || ' | '::text) || hierarchical_relationship.vendor_id_target::text AS lineage_path
   FROM hierarchical_relationship;
-______________________________
-- orbit_64407564mmy3009.spep_measurement_lookup source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.spep_measurement_lookup
AS SELECT ((((((((study_subject.study_id::text || '|'::text) || study_subject.study_id::text) || '|'::text) || study_subject.subject_id::text) || COALESCE(trunc(spep.specimen_collection_date)::character varying, ''::character varying)::text) || 
        CASE
            WHEN spep.specimen_collection_date IS NOT NULL THEN '|'::text
            ELSE ''::text
        END) || COALESCE(spep.spep_mg_dl::character varying, ''::character varying)::text) || 
        CASE
            WHEN spep.spep_mg_dl IS NOT NULL THEN '|'::text
            ELSE ''::text
        END) || COALESCE(spep.visit_id, ''::character varying)::text AS unique_key, study_subject.study_id, study_subject.subject_id, study_subject.site_id, spep.specimen_collection_date AS spep_collection_date, spep.spep_mg_dl, spep.visit_id
   FROM orbit_64407564mmy3009.study_subject study_subject
   LEFT JOIN ( SELECT DISTINCT spep_kappa_lambda.subject_id, spep_kappa_lambda.study_id, spep_kappa_lambda.accession_number, spep_kappa_lambda.specimen_collection_date, spep_kappa_lambda.visit_id, specimen_test.test_name, specimen_test.test_result_orig_value_numeric::numeric * 100::numeric AS spep_mg_dl
           FROM ( SELECT specimen.subject_id, specimen.study_id, specimen.specimen_id, specimen.accession_number, specimen.specimen_collection_date, specimen.visit_id, specimen_test.test_name, specimen_test.test_result_orig_value_numeric
                   FROM orbit_64407564mmy3009.specimen specimen
              LEFT JOIN orbit_64407564mmy3009.specimen_test specimen_test ON specimen.specimen_id::text = specimen_test.specimen_id::text
             WHERE specimen_test.test_name::text = 'MyeloSPE Immunofix.Impress1-CL'::text AND specimen_test.test_result_orig_value::text ~~ 'IgG%'::text) spep_kappa_lambda
      JOIN orbit_64407564mmy3009.specimen specimen ON spep_kappa_lambda.subject_id::text = specimen.subject_id::text AND spep_kappa_lambda.accession_number::text = specimen.accession_number::text AND trunc(spep_kappa_lambda.specimen_collection_date) = trunc(specimen.specimen_collection_date)
   JOIN orbit_64407564mmy3009.specimen_test specimen_test ON spep_kappa_lambda.specimen_id::text = specimen_test.specimen_id::text
  WHERE specimen_test.test_name::text = 'Total M-Protein, Serum-CL-QT'::text) spep ON study_subject.subject_id::text = spep.subject_id::text;
___________________
-- orbit_64407564mmy3009.study_alias source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.study_alias
AS SELECT study_alias.study_id, study_alias.study_alias, study_alias.run_id
   FROM orbit.study_alias;
_____________________________
-- orbit_64407564mmy3009.test_results_vw source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.test_results_vw
AS SELECT DISTINCT COALESCE(ss.subject_id, sp.subject_id) AS subject_id, ss.study_arm, ss.cohort, ss.study_subject_status, ss.date_enrollment, ss.date_termination, ss.date_treat_termination, ss.date_screening, ss.date_screen_failure, t.site_id, t.site_country_name, s.specimen_test_id, s.specimen_id, s.study_id, s.vendor_id, s.vendor_specimen_id, s.test_code, s.test_name, s.test_category, s.test_result_orig_value, s.test_result_orig_value_string, s.test_result_orig_value_numeric, s.test_result_orig_value_datetime, s.test_result_orig_value_cancelled, s.test_result_orig_unit, s.test_result_std_value, s.test_result_std_unit, s.test_status, s.basline_flag, s.test_start_date_time, s.test_end_date_time, s.test_category_code, s.test_result_date, s.test_filed_date, s.test_review_date, s.reason_test_qualified_or_failed, s."comment", s.labcorp_sequence_num, s.run_id, s.composite_primary_key, s.row_id, NULL::text AS test_type, sp.visit_id, v.vendor_name, coi.report_value
   FROM orbit_64407564mmy3009.specimen_test s
   JOIN orbit_64407564mmy3009.codes_of_interest coi ON s.test_code::text = coi.value::text
   JOIN ( SELECT sp.specimen_id, sp.accession_number, sp.study_subject, sp.study_id, sp.subject_id, sp.pre_screening_id, sp.visit_id, sp.vendor_id, sp.specimen_class, sp.specimen_type, sp.storage_location, sp.storage_state, sp.storage_temperature, sp.vendor_specimen_id, sp.vendor_subject_id, sp.vendor_study_id, sp.site_specimen_id, sp.specimen_condition, sp.specimen_extract_location, sp.specimen_collection_date, sp.specimen_received_date, sp.vendor_specimen_type, sp.specimen_status, sp.specimen_accession_date, sp.specimen_reporting_date, sp.repeat_status, sp.repeat_times, sp.number_of_slides, sp.number_of_slides_needed, sp.reason_qualified_or_failed, sp.sample_pass_fail_status, sp.run_id, sp.composite_primary_key, sp.row_id
      FROM orbit_64407564mmy3009.specimen sp
     WHERE sp.specimen_status IS NOT NULL) sp ON s.specimen_id::text = sp.specimen_id::text AND s.vendor_id = sp.vendor_id
   JOIN orbit_64407564mmy3009.study_subject ss ON "right"(sp.subject_id::text, 11) = "right"(ss.subject_id::text, 11)
   LEFT JOIN orbit_64407564mmy3009.study_site sst ON ss.site_id::text = sst.site_id::text AND ss.study_id::text = sst.study_id::text
   LEFT JOIN orbit_64407564mmy3009.site t ON ss.site_id::text = t.site_id::text AND ss.study_id::text = t.study_id::text AND sst.site_country::text = t.site_country_code::text
   LEFT JOIN orbit_64407564mmy3009.vendor v ON s.vendor_id = v.vendor_id;
_______________________
-- orbit_64407564mmy3009.unstructured_data_lookup source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.unstructured_data_lookup
AS SELECT DISTINCT udl.file_name, udl.mapping_attribute, udl.source_file_location, udl.study_id, spec.specimen_id, udl.publish_file_location, udl.vendor, udl.data_type, udl.time_of_ingestion, sub.subject_id, udl.file_size, udl.source_modified_timestamp
   FROM orbit.unstructured_data_lookup udl
   LEFT JOIN orbit.unstructured_data_specimen spec ON btrim(lower(udl.source_file_location::text)) = btrim(lower(spec.source_file_location::text)) AND btrim(lower(udl.publish_file_location::text)) = btrim(lower(spec.publish_file_location::text)) AND (udl.source_modified_timestamp::text = spec.source_modified_timestamp::text OR udl.source_modified_timestamp IS NULL AND spec.source_modified_timestamp IS NULL)
   LEFT JOIN orbit.unstructured_data_subject sub ON btrim(lower(udl.source_file_location::text)) = btrim(lower(sub.source_file_location::text)) AND btrim(lower(udl.publish_file_location::text)) = btrim(lower(sub.publish_file_location::text)) AND (udl.source_modified_timestamp::text = sub.source_modified_timestamp::text OR udl.source_modified_timestamp IS NULL AND sub.source_modified_timestamp IS NULL)
  WHERE udl.study_id::text = '64407564MMY3009'::text;_________________
____________________________
-- orbit_64407564mmy3009.vendor source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.vendor
AS SELECT vendor.vendor_id, vendor.vendor_name, vendor.run_id
   FROM orbit.vendor;
_____________________
-- orbit_64407564mmy3009.vendor_alias source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.vendor_alias
AS SELECT vendor_alias.vendor_id, vendor_alias.vendor_alias, vendor_alias.run_id
   FROM orbit.vendor_alias;
