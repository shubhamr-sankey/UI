-- orbit_64407564mmy3009.code_validation_vw source

CREATE OR REPLACE VIEW orbit_64407564mmy3009.code_validation_vw
AS SELECT DISTINCT sid.study_id, v.vendor_name, 'sm_code'::text AS value_type, sp.specimen_type, sp.vendor_specimen_type AS orig_value, 
        CASE
            WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'SM%'::text THEN "substring"(sp.vendor_specimen_type::text, 1, 4)
            WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'HM%'::text THEN "substring"(sp.vendor_specimen_type::text, 1, 4)
            WHEN sp.vendor_id = 3 AND sp.specimen_class::text ~~ 'TBO%'::text THEN "substring"(sp.specimen_class::text, 1, 6)
            WHEN sp.vendor_id = 21 THEN sp.specimen_class::text
            ELSE NULL::text
        END::character varying AS value, c.report_value_type, 
        CASE
            WHEN sp.vendor_id = 3 THEN c.report_value
            WHEN sp.vendor_id = 21 THEN initcap(sp.specimen_type::text)::character varying
            ELSE NULL::character varying
        END AS report_value, sp.specimen_class, NULL::text AS test_name
   FROM orbit_64407564mmy3009.specimen sp
   LEFT JOIN ( SELECT codes_of_interest.study_id, codes_of_interest.value_type, codes_of_interest.value, codes_of_interest.vendor, codes_of_interest.report_value_type, codes_of_interest.report_value
           FROM orbit_64407564mmy3009.codes_of_interest
          WHERE codes_of_interest.value_type::text = 'sm_code'::text) c ON "substring"(sp.vendor_specimen_type::text, 1, 4) = 
   CASE
       WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'SM%'::text THEN c.value
       WHEN sp.vendor_id = 3 AND sp.vendor_specimen_type::text ~~ 'HM%'::text THEN c.value
       ELSE NULL::character varying
   END::text OR "substring"(sp.specimen_class::text, 1, 6) = 
   CASE
       WHEN sp.vendor_id = 3 AND sp.specimen_class::text ~~ 'TBO%'::text THEN c.value
       ELSE NULL::character varying
   END::text OR sp.vendor_id::text = 
   CASE
       WHEN sp.vendor_id = 21 THEN c.vendor
       ELSE NULL::character varying
   END::text
   JOIN ( SELECT DISTINCT codes_of_interest.study_id
      FROM orbit_64407564mmy3009.codes_of_interest) sid ON 1 = 1
   LEFT JOIN orbit_64407564mmy3009.vendor v ON c.vendor::text = v.vendor_id::text
  WHERE sp.vendor_specimen_type IS NOT NULL AND sp.vendor_id = 3 OR sp.vendor_id = 21
UNION ALL 
 SELECT DISTINCT sid.study_id, v.vendor_name, 'test_code'::text AS value_type, NULL::text AS specimen_type, s.test_code AS orig_value, c.value, c.report_value_type, c.report_value, NULL::text AS specimen_class, s.test_name
   FROM orbit_64407564mmy3009.specimen_test s
   JOIN ( SELECT sp.specimen_id, sp.accession_number, sp.study_subject, sp.study_id, sp.subject_id, sp.pre_screening_id, sp.visit_id, sp.vendor_id, sp.specimen_class, sp.specimen_type, sp.storage_location, sp.storage_state, sp.storage_temperature, sp.vendor_specimen_id, sp.vendor_subject_id, sp.vendor_study_id, sp.site_specimen_id, sp.specimen_condition, sp.specimen_extract_location, sp.specimen_collection_date, sp.specimen_received_date, sp.vendor_specimen_type, sp.specimen_status, sp.specimen_accession_date, sp.specimen_reporting_date, sp.repeat_status, sp.repeat_times, sp.number_of_slides, sp.number_of_slides_needed, sp.reason_qualified_or_failed, sp.sample_pass_fail_status, sp.run_id, sp.composite_primary_key, sp.row_id
           FROM orbit_64407564mmy3009.specimen sp
          WHERE sp.specimen_status IS NOT NULL) sp ON s.specimen_id::text = sp.specimen_id::text AND s.vendor_id = sp.vendor_id
   LEFT JOIN ( SELECT codes_of_interest.study_id, codes_of_interest.value_type, codes_of_interest.value, codes_of_interest.vendor, codes_of_interest.report_value_type, codes_of_interest.report_value
      FROM orbit_64407564mmy3009.codes_of_interest
     WHERE codes_of_interest.value_type::text = 'test_code'::text) c ON s.test_code::text = c.value::text
   LEFT JOIN orbit_64407564mmy3009.vendor v ON c.vendor::text = v.vendor_id::text
   JOIN ( SELECT DISTINCT codes_of_interest.study_id
   FROM orbit_64407564mmy3009.codes_of_interest) sid ON 1 = 1;
